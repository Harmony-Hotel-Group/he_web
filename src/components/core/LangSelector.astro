---
import { languages, type Language, getCurrentLang } from "@/i18n/translation";

const currentLang = getCurrentLang(Astro.url);
const currentPath = Astro.url.pathname.replace(/^\/(en)/, "") || "/";

import { log } from "@/services/logger.ts";
const CONTEXT = "LangSelector";
---

<div class="relative language-switcher-container mr-2">
    <button
            type="button"
            id="languageButton"
            class="flex items-center bg-transparent text-white py-1 px-2 rounded-md cursor-pointer focus:outline-hidden text-sm"
            aria-haspopup="true"
            aria-expanded="false"
            data-current-lang={currentLang}
            data-current-path={currentPath}
    >
        <img
                id="currentFlag"
                src={`/src/resources/img/flags/${currentLang}.svg`}
                alt={`${languages[currentLang]} flag`}
                class="h-5 w-5"
        />
        <span class="hidden" id="currentLangName">{languages[currentLang]}</span>
        <svg
                class="w-3 h-3 ml-1 hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
        >
            <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
            ></path>
        </svg>
    </button>

    <div id="languageDropdown" class="absolute right-0 mt-2 w-32 bg-gray-700 rounded-md shadow-lg z-20 hidden">
        {Object.entries(languages).map(([langCode, langName]) => (
                <button
                        type="button"
                        class="lang-option flex items-center space-x-2 w-full text-left px-3 py-2 text-sm text-white hover:bg-gray-600"
                        data-lang={langCode}
                >
                    <img
                            src={`/src/resources/img/flags/${langCode}.svg`}
                            alt={`${langName} flag`}
                            class="h-4 w-4"
                    />
                    <span>{langName}</span>
                </button>
        ))}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const { setLangCookie } = await import('@/i18n/translation');

        const button = document.getElementById('languageButton');
        const dropdown = document.getElementById('languageDropdown');
        const langOptions = document.querySelectorAll('.lang-option');

        // Toggle dropdown
        button?.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = dropdown?.classList.contains('hidden');
            dropdown?.classList.toggle('hidden');
            button.setAttribute('aria-expanded', String(isOpen));
        });

        // Close dropdown when clicking outside
        document.addEventListener('mousedown', (event) => {
            const target = event.target;
            if (target && !target.closest('.language-switcher-container')) {
                dropdown?.classList.add('hidden');
                button?.setAttribute('aria-expanded', 'false');
            }
        });

        // Handle language change
        langOptions.forEach(option => {
            option.addEventListener('click', async (e) => {
                const newLang = e.currentTarget.getAttribute('data-lang');
                const currentPath = button?.getAttribute('data-current-path') || '/';

                // Guardar preferencia en cookie
                setLangCookie(newLang);

                // Construir la URL correcta según el idioma
                let targetPath = currentPath;
                let displayPath = currentPath;

                if (newLang === 'en') {
                    targetPath = `/en${currentPath}`;
                    displayPath = currentPath;
                }

                // Limpiar sessionStorage para permitir redirección
                sessionStorage.removeItem('langRedirected');

                // Hacer fetch de la nueva página
                try {
                    const response = await fetch(targetPath);
                    if (!response.ok) throw new Error('Error al cargar la página');

                    const html = await response.text();
                    const parser = new DOMParser();
                    const newDoc = parser.parseFromString(html, 'text/html');

                    // Actualizar el título
                    document.title = newDoc.title;

                    // Actualizar todo el body
                    const newBody = newDoc.querySelector('body');
                    const currentBody = document.querySelector('body');
                    if (newBody && currentBody) {
                        currentBody.innerHTML = newBody.innerHTML;
                    }

                    // Actualizar el atributo lang del html
                    document.documentElement.lang = newLang;

                    // Actualizar la URL mostrada (sin /en/)
                    history.pushState({ lang: newLang }, '', displayPath);

                    // Re-inicializar después de actualizar el DOM
                    setTimeout(() => location.reload(), 0);

                } catch (error) {
                    console.error('Error al cambiar idioma:', error);
                    // Fallback: navegación tradicional
                    window.location.href = targetPath;
                }
            });
        });
    });
</script>

<style>
    .language-switcher-container {
        display: inline-block;
    }

    button {
        transition: background-color 0.2s ease;
    }

    button:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    /* Asegurar que el dropdown aparezca por encima de otros elementos */
    .z-20 {
        z-index: 20;
    }
</style>