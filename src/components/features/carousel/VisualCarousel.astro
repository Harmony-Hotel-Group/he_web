---
// src/components/features/carousel/VisualCarousel.astro
import VisualResource from '../../ui/VisualResource.astro';

interface Resource {
  src: string;
  type: 'image' | 'video' | 'youtube'; // Added 'youtube' type
  alt?: string;
  youtubeId?: string; // Added youtubeId
}

interface Props {
  resources: Resource[];
  class?: string;
  maskOpacityClass?: string; // New prop for mask opacity
  objectFitClass?: string; // New prop for object-fit control
  videoZoomScale?: number; // New prop for additional video zoom
}

const { 
  resources, 
  class: className, 
  maskOpacityClass = 'bg-black/50', 
  objectFitClass = 'object-cover',
  videoZoomScale = 1.15
} = Astro.props; 

// Default placeholder images if no valid resources are provided
const defaultPlaceholderResources: Resource[] = [
  { src: '/images/placeholders/placeholder1.jpg', type: 'image', alt: 'Placeholder Image 1' },
  { src: '/images/placeholders/placeholder2.jpg', type: 'image', alt: 'Placeholder Image 2' },
  { src: '/images/placeholders/placeholder3.jpg', type: 'image', alt: 'Placeholder Image 3' },
];

// Function to extract YouTube video ID
function getYouTubeVideoId(url: string): string | null {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length === 11) ? match[2] : null;
}

let processedResources: Resource[] = [];

// Process incoming resources
if (resources && resources.length > 0) {
  processedResources = resources.map(res => {
    if (res.type === 'video') {
      const youtubeId = getYouTubeVideoId(res.src);
      if (youtubeId) {
        return { ...res, type: 'youtube', youtubeId: youtubeId };
      }
    }
    return res;
  });
}

// Filter resources for initial display logic
const videos = processedResources.filter(r => r.type === 'video'); // General videos (not YouTube)
const youtubeVideos = processedResources.filter(r => r.type === 'youtube');
const images = processedResources.filter(r => r.type === 'image');

let finalResources: Resource[] = [];
let showVideoInitially = false; // This will now refer to either general video or YouTube

// Server-side user-agent detection for initial render
const userAgent = Astro.request.headers.get('user-agent') || '';
const isMobileDevice = /Mobile|Android|iPhone|iPad|iPod|Windows Phone/i.test(userAgent);

// Priority: YouTube -> General Video -> Images -> Placeholder
if (youtubeVideos.length > 0 && !isMobileDevice) {
  finalResources = [youtubeVideos[0]];
  showVideoInitially = true;
} else if (videos.length > 0 && !isMobileDevice) {
  finalResources = [videos[0]];
  showVideoInitially = true;
} else if (images.length > 0) {
  finalResources = images;
} else {
  // Fallback to default placeholders if no valid resources are found
  finalResources = defaultPlaceholderResources;
  showVideoInitially = false; // Placeholders are always images
}

// If we decided to show a video initially, but it's mobile, revert to images or placeholders
if (showVideoInitially && isMobileDevice) {
  showVideoInitially = false;
  finalResources = images.length > 0 ? images : defaultPlaceholderResources;
}

// Determine the resource to display if it's a single video (YouTube or general)
const singleVideoResource = showVideoInitially ? finalResources[0] : undefined;

// Determine the resources for the image carousel
const carouselImageResources = showVideoInitially ? [] : finalResources;

// Ensure carouselImageResources always has items if it's meant to be an image carousel
if (!singleVideoResource && carouselImageResources.length === 0) {
    carouselImageResources.push(...defaultPlaceholderResources);
}

---

<div class:list={[className, 'relative w-full overflow-hidden']}>
  {
    singleVideoResource ? (
      singleVideoResource.type === 'youtube' ? (
        <div class="relative w-full h-screen"> {/* This is the container for the YouTube video */} 
          <iframe
            class:list={['absolute inset-0 w-full h-full z-0', objectFitClass]} 
            style={`transform: scale(${videoZoomScale});`} // Apply zoom here
            src={`https://www.youtube.com/embed/${singleVideoResource.youtubeId}?autoplay=1&mute=1&loop=1&playlist=${singleVideoResource.youtubeId}&controls=0&showinfo=0&autohide=1&modestbranding=1&rel=0`}
            frameborder="0"
            allow="autoplay; encrypted-media" 
            allowfullscreen
            title={singleVideoResource.alt || 'YouTube video'}
          ></iframe>
          {/* Opacity Mask - positioned over the iframe, z-index 1 */} 
          <div class:list={['absolute inset-0 z-[1]', maskOpacityClass]}></div>
        </div>
      ) : ( // General video type
        <VisualResource src={singleVideoResource.src} type="video" alt={singleVideoResource.alt} class:list={['w-full h-screen', objectFitClass]} />
      )
    ) : (
      <div class="relative w-full h-screen">
        <div id="carousel-container" class="relative h-full">
          {carouselImageResources.map((resource, index) => (
            <div
              class:list={[
                'absolute inset-0 transition-opacity duration-700 ease-in-out',
                index === 0 ? 'opacity-100' : 'opacity-0 hidden',
              ]}
              data-carousel-item
            >
              <VisualResource src={resource.src} type="image" alt={resource.alt} class:list={['w-full h-full', objectFitClass]} />
            </div>
          ))}
        </div>

        <!-- Slider controls -->
        {carouselImageResources.length > 1 && (
          <div class="absolute inset-0"> {/* Wrapped buttons in a div */}
            <button type="button" class="absolute top-0 start-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none" data-carousel-prev>
              <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/30 group-hover:bg-white/50 group-focus:ring-4 group-focus:ring-white group-focus:outline-none">
                <svg class="w-4 h-4 text-white rtl:rotate-180" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 1 1 5l4 4"/>
                </svg>
                <span class="sr-only">Previous</span>
              </span>
            </button>
            <button type="button" class="absolute top-0 end-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none" data-carousel-next>
              <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/30 group-hover:bg-white/50 group-focus:ring-4 group-focus:ring-white group-focus:outline-none">
                <svg class="w-4 h-4 text-white rtl:rotate-180" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/>
                </svg>
                <span class="sr-only">Next</span>
              </span>
            </button>
          </div>
        )}
      </div>
    )
  }
</div>

<script is:inline>
  // Client-side carousel logic
  document.addEventListener('DOMContentLoaded', () => {
    const carouselContainer = document.getElementById('carousel-container');
    if (!carouselContainer) return;

    const items = carouselContainer.querySelectorAll('[data-carousel-item]');
    if (items.length <= 1) { // No need for controls if 0 or 1 item
      const prevButton = document.querySelector('[data-carousel-prev]');
      const nextButton = document.querySelector('[data-carousel-next]');
      if (prevButton) prevButton.style.display = 'none';
      if (nextButton) nextButton.style.display = 'none';
      return;
    }

    const prevButton = document.querySelector('[data-carousel-prev]');
    const nextButton = document.querySelector('[data-carousel-next]');
    let currentIndex = 0;

    function showItem(index) {
      items.forEach((item, i) => {
        if (i === index) {
          item.classList.remove('opacity-0', 'hidden');
          item.classList.add('opacity-100');
        } else {
          item.classList.remove('opacity-100');
          item.classList.add('opacity-0', 'hidden');
        }
      });
    }

    if (prevButton) {
      prevButton.addEventListener('click', () => {
        currentIndex = (currentIndex - 1 + items.length) % items.length;
        showItem(currentIndex);
      });
    }

    if (nextButton) {
      nextButton.addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % items.length;
        showItem(currentIndex);
      });
    }
  });
</script>
