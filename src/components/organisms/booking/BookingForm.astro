---
// src/components/organisms/booking/BookingForm.astro
import Button from "@/components/atoms/Button.astro";
import Label from "@/components/atoms/Label.astro";
import TextAreaInput from "@/components/atoms/TextAreaInput.astro";

import DatePickerField from "@/components/molecules/forms/DatePickerField.astro";
import DropDownField from "@/components/molecules/forms/DropdownField.astro";
import SwitchField from "@/components/molecules/forms/SwitchField.astro";
import { Translations } from "@/i18n/translation.ts";
import Grid from "@/layouts/GridLayout.astro";
import Row from "@/layouts/Row.astro";

import { range } from "@/utils/math.ts";
import BookingVehicleSection from "./BookingVehicleSection.astro";
import ModalBookingGroup from "./ModalBookingGroup.astro";

interface Props {
	lang: string;
	config: any;
}

const { lang, config } = Astro.props;

const t = Translations(lang);

const adultsOptions = range(1, 9).map((i, index, array) => {
	if (index === array.length - 1) {
		return {
			value: "group",
			label: t("booking.dropdown.optGroup"),
		};
	}
	return {
		value: `${i}`,
		label: `${t("booking.dropdown.optAdults", {
			i: i,
			s: i > 1 ? "s" : "",
		})}`,
	};
});

const childrenOptions = range(0, 8).map((i, index, array) => {
	return {
		value: `${i}`,
		label: `${t("booking.dropdown.optChildren", {
			i: i === 0 ? "Sin" : i,
			s: i === 0 ? "s" : i > 1 ? "s" : "",
		})}`,
	};
});

const roomsOptions = range(1, 5).map((i, index, array) => {
	return {
		value: `${i}`,
		label: `${t("booking.dropdown.optRooms", {
			i: i,
			s: i > 1 ? "es" : "",
		})}`,
	};
});

const vehicleTypeOptions = [
	{ value: "auto", label: "Auto" },
	{ value: "suv", label: "SUV" },
	{ value: "camioneta", label: "Camioneta" },
	{ value: "furgoneta", label: "Furgoneta" },
	{ value: "buseta", label: "Buseta" },
	{ value: "bus", label: "Bus" },
	{ value: "otro", label: "Otro" },
];

const whatsappNumber = config?.contactInfo?.whatsapp ?? "";
const email = config?.contactInfo?.email ?? "";
---

<form id="booking-form" method="post" class="rounded-xl space-y-3"
      data-whatsapp={whatsappNumber}
      data-email={email}>

    <Grid cols={5}>
        <div data-col-span="2">
            <DatePickerField
                    fieldId="dateRange"
                    name="dateRange"
                    lblKey="booking.dateRange.title"
                    icon="form/calendar"
                    lang={lang}
            />
        </div>
        <DropDownField
                fieldId="adults"
                name="adults"
                initialValue={2}
                icon="form/adult"
                lblKey="booking.dropdown.lblAdults"
                lang={lang}
                options={adultsOptions}
        />

        <DropDownField
                fieldId="children"
                name="children"
                icon="form/teen"
                lblKey="booking.dropdown.lblChildren"
                lang={lang}
                options={childrenOptions}
        />

        <DropDownField
                fieldId="rooms"
                name="rooms"
                icon="form/bed"
                lblKey="booking.dropdown.lblRooms"
                lang={lang}
                options={roomsOptions}
        />
    </Grid>


    <!-- Switches -->
    <Row>
        <SwitchField fieldId="breakfast" name="breakfast" lblKey="booking.switch.breakfast" lang={lang} checked
                     icon="form/breakfast"/>
        <SwitchField fieldId="vehicle" name="vehicle" lblKey="booking.switch.vehicle" lang={lang} icon="form/vehicle"/>
        <!--<SwitchField fieldId="special_request" name="request" lblKey="booking.switch.special_request" lang={lang}/>-->
    </Row>

    <!-- Sección de Vehículos (oculta inicialmente) -->
    <div id="vehicle-section" class="hidden">
        <BookingVehicleSection lang={lang} config={config} client:load/>
    </div>

    <div id="special_request-section" class="hidden">
        <Label forId="groupNotes" lang={lang} lblKey="booking.group.notes" classes="pr-5"/>
        <TextAreaInput
                id="groupNotes"
                name="groupNotes"
                keyPlaceholder='booking.group.notesPlaceholder'
                lang={lang}
        />
    </div>

    <div class="text-center pt-4">
        <Button _id="btnSubmit" type="button" lblKey="booking.btn.search" lang={lang} variant="accent"
                className="w-full md:w-auto px-12" icon="search" color="#FFFFFF"/>
    </div>
</form>

<!-- Modal para reservas grupales -->
<ModalBookingGroup lang={lang} config={config} isOpen={false} client:load/>

<script>
    import { actions } from 'astro:actions';

    document.addEventListener("DOMContentLoaded", async () => {
        const { logger } = await import('@/services/logger.ts');
        const log = logger('BookingForm:Client');

        const form: HTMLFormElement = document.getElementById('booking-form') as HTMLFormElement;
        if (!form) return;

        const bookingBar = form.closest('#booking-bar');
        const vehicleSection = document.getElementById('vehicle-section');
        const vehicleSwitchButton = form.querySelector('button#vehicle');

        if (vehicleSwitchButton && vehicleSection) {
            const observer = new MutationObserver((mutations) => {
                const mutation = mutations[0];
                if (mutation.attributeName !== 'aria-checked') return;

                const isChecked = vehicleSwitchButton.getAttribute('aria-checked') === 'true';
                vehicleSection.classList.toggle('hidden', !isChecked);
                bookingBar?.classList.toggle('max-h-[80vh]', isChecked);
                bookingBar?.classList.toggle('overflow-y-auto', isChecked);
            });

            observer.observe(vehicleSwitchButton, {
                attributes: true,
                attributeFilter: ['aria-checked']
            });
        }

        // --- Lógica para el Modal de Grupo ---
        // Espera a que el componente ModalBookingGroup anuncie que está listo.
        document.addEventListener('modalBookingGroupReady', () => {
            log.info('Evento modalBookingGroupReady recibido. Inicializando lógica del modal.');

            // Ahora es seguro crear la instancia del modal.
            const modalInstance = new (window as any).ModalBookingGroupClass();
            const adultsDropdown = document.getElementById('adults');

            adultsDropdown?.addEventListener('change', (e) => {
                const target = e.target as HTMLSelectElement;
                if (target.value === 'group') {
                    log.info("Opción 'group' seleccionada. Abriendo modal.");
                    modalInstance.open();
                    // Opcional: resetear el dropdown a un valor por defecto para que no se quede en "Grupo"
                    target.value = "2";
                }
            });
        });

        function clearValidationErrors() {
            form.querySelectorAll('[id^="error_"]').forEach(el => el.classList.add('hidden'));
            form.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
        }

        function handleValidationErrors(errors) {
            for (const fieldError of errors) {
                const fieldName = fieldError.path[0];
                const inputElement = document.getElementById(fieldName);
                const errorElement = document.getElementById(`error_${fieldName}`);

                if (inputElement) {
                    inputElement.classList.add('border-red-500');
                }
                if (errorElement) {
                    errorElement.textContent = fieldError.message;
                    errorElement.classList.remove('hidden');
                }
            }
        }

        const btn = document.getElementById('btnSubmit') as HTMLButtonElement;
        btn?.addEventListener('click', async () => {
            clearValidationErrors();
            const originalButtonHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Enviando...`;

            try {
                const formData = new FormData(form);
                const whatsappNumber = form.dataset.whatsapp;
                const {data, error} = await actions.booking(formData);

                if (error) {
                    console.error("Validation error:", error);
                    handleValidationErrors(error.fields);
                    window.showToast('Por favor, revisa los campos del formulario.', 'error');
                    return;
                }

                const {processing} = data;
                let message = `
*Estimado Hotel Ensueños por favor necesito que me ayude con una reserva:*

➢ Check In: ${processing.checkin}
➢ Check Out: ${processing.checkout}
➢ Cantidad de Noches: ${processing.nights}
➢ Adultos: ${processing.adults}
➢ Niños: ${processing.children}
➢ Habitaciones: ${processing.rooms}
➢ Desayuno incluido: ${processing.breakfast === "true" ? "Sí" : "No"}`;

                const isVehicleChecked = vehicleSwitchButton?.getAttribute('aria-checked') === 'true';
                if (isVehicleChecked) {
                    message += `\n➢ *Vehículos:*`;
                    const vehicleItems = vehicleSection.querySelectorAll('.vehicle-item');
                    vehicleItems.forEach((item, index) => {
                        const type = (item.querySelector(`select[name^="vehicleType"]`) as HTMLSelectElement)?.value;
                        const plate = (item.querySelector(`input[name^="vehiclePlate"]`) as HTMLInputElement)?.value;
                        if (type) {
                            message += `\n   ${index + 1}. Tipo: ${type}, Placa: ${plate || 'N/A'}`;
                        }
                    });
                }

                message += `\n\nSi hace falta información adicional, por favor responder a este mensaje.`;
                const encodedMessage = encodeURIComponent(message.trim());

                if (whatsappNumber) {
                    window.open(`https://wa.me/${whatsappNumber}?text=${encodedMessage}`, "_blank");
                    window.showToast('Tu solicitud de reserva ha sido enviada.', 'success');
                } else {
                    window.showToast('No se pudo enviar el mensaje, el número de WhatsApp no está configurado.', 'error');
                }

            } catch (err) {
                console.error("Error inesperado al enviar la reserva:", err);
                window.showToast('Ocurrió un error inesperado. Por favor, inténtalo de nuevo.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalButtonHTML;
            }
        });
    });
</script>

<style>
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        opacity: 1;
    }
</style>
