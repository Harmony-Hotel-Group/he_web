---
// src/components/organisms/carousel/VisualCarousel.astro
interface Props {
    class?: string;
    maskOpacityClass?: string;
    autoplayInterval?: number;
    showIndicators?: boolean;
    showScrollIndicator?: boolean;
}

const {
    class: className = '',
    maskOpacityClass = 'bg-black/50',
    autoplayInterval = 5000,
    showIndicators = true,
    showScrollIndicator = true,
} = Astro.props;

const carouselId = `carousel-${Math.random().toString(36).substr(2, 9)}`;
---

<div
    class:list={[className, 'relative w-full min-h-[100dvh] overflow-hidden']}
    data-carousel-id={carouselId}
>
    <div class="absolute inset-0 w-full h-full" data-carousel-container>
        <slot />
    </div>

    <!-- Indicators (dots) -->
    {showIndicators && (
        <div class="absolute bottom-16 left-1/2 z-30 flex -translate-x-1/2 space-x-3" data-carousel-indicators></div>
    )}

    <!-- Navigation arrows -->
    <button
        type="button"
        class="absolute top-1/2 left-4 z-30 -translate-y-1/2 flex items-center justify-center w-12 h-12 rounded-full bg-white/20 hover:bg-white/30 backdrop-blur-sm transition-all group"
        data-carousel-prev
        aria-label="Slide anterior"
    >
        <svg class="w-6 h-6 text-white group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
    </button>
    <button
        type="button"
        class="absolute top-1/2 right-4 z-30 -translate-y-1/2 flex items-center justify-center w-12 h-12 rounded-full bg-white/20 hover:bg-white/30 backdrop-blur-sm transition-all group"
        data-carousel-next
        aria-label="Slide siguiente"
    >
        <svg class="w-6 h-6 text-white group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
    </button>

    <!-- Scroll Down Indicator -->
    {showScrollIndicator && (
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-30 animate-bounce cursor-pointer" data-scroll-indicator>
            <svg class="w-8 h-8 text-white drop-shadow-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </div>
    )}
</div>

<script is:inline define:vars={{autoplayInterval, carouselId}}>
    class VisualCarouselManager {
        private container: HTMLElement | null = null;
        private items: HTMLElement[] = [];
        private indicatorsContainer: HTMLElement | null = null;
        private indicators: HTMLElement[] = [];
        private currentIndex: number = 0;
        private intervalId: number | null = null;

        constructor(carouselId: string, interval: number) {
            this.init(carouselId, interval);
        }

        private init(carouselId: string, interval: number) {
            const carousel = document.querySelector(`[data-carousel-id="${carouselId}"]`);
            if (!carousel) return;

            this.container = carousel.querySelector('[data-carousel-container]');
            if (!this.container) return;

            this.items = Array.from(this.container.children) as HTMLElement[];
            this.indicatorsContainer = carousel.querySelector('[data-carousel-indicators]');

            if (this.items.length <= 1) {
                carousel.querySelector('[data-carousel-prev]')?.remove();
                carousel.querySelector('[data-carousel-next]')?.remove();
                this.indicatorsContainer?.remove();
                return;
            }

            this.createIndicators();
            this.initEventListeners();
            this.updateSlide(0);
            this.start(interval);
        }

        private createIndicators() {
            if (!this.indicatorsContainer) return;
            this.items.forEach((_, index) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.classList.add('w-3', 'h-3', 'rounded-full', 'transition-all', 'duration-300');
                button.setAttribute('aria-label', `Ir a slide ${index + 1}`);
                button.dataset.slideTo = index.toString();
                this.indicatorsContainer.appendChild(button);
            });
            this.indicators = Array.from(this.indicatorsContainer.children) as HTMLElement[];
        }

        private initEventListeners() {
            const carousel = document.querySelector(`[data-carousel-id="${carouselId}"]`);
            carousel?.querySelector('[data-carousel-prev]')?.addEventListener('click', () => this.prev());
            carousel?.querySelector('[data-carousel-next]')?.addEventListener('click', () => this.next());
            this.indicators.forEach(ind => ind.addEventListener('click', (e) => this.goToSlide(parseInt((e.target as HTMLElement).dataset.slideTo || '0'))));
        }

        private updateSlide(index: number) {
            this.items.forEach((item, i) => {
                item.classList.toggle('opacity-100', i === index);
                item.classList.toggle('opacity-0', i !== index);
                item.classList.toggle('z-10', i === index);
                item.classList.toggle('z-0', i !== index);
            });
            this.indicators.forEach((indicator, i) => {
                indicator.classList.toggle('bg-white', i === index);
                indicator.classList.toggle('w-8', i === index);
                indicator.classList.toggle('bg-white/50', i !== index);
                indicator.classList.toggle('w-3', i !== index);
            });
            this.currentIndex = index;
        }

        private next() {
            this.goToSlide((this.currentIndex + 1) % this.items.length);
        }

        private prev() {
            this.goToSlide((this.currentIndex - 1 + this.items.length) % this.items.length);
        }

        private start(interval: number) {
            this.intervalId = window.setInterval(() => this.next(), interval);
        }
    }

    new VisualCarouselManager(carouselId, autoplayInterval);
</script>
