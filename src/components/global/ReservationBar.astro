---
import { useI18n } from '@/i18n/useI18n';
import Button from '../ui/Button.astro';
import Toggle from '../ui/Toggle.astro';

const { siteConfig } = await import('@/data/siteConfig.json');
const { t } = useI18n();

// Set default dates (today and tomorrow)
const today = new Date();
const tomorrow = new Date(today);
tomorrow.setDate(tomorrow.getDate() + 1);

const formatDate = (date: Date) => {
  return date.toISOString().split('T')[0];
};

const checkInDate = formatDate(today);
const checkOutDate = formatDate(tomorrow);
---

<section class="bg-hotel-primary text-white py-8">
  <div class="container mx-auto px-4">
    <div class="text-center mb-6">
      <h2 class="text-2xl md:text-3xl font-bold mb-2">
        {t('reservations.bookNow')}
      </h2>
      <p class="text-hotel-accent">
        {t('reservations.subtitle')}
      </p>
    </div>

    <form class="max-w-4xl mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- First Row: Dates and Guests -->
        <div class="grid grid-cols-3 gap-4">
          <!-- Check-in Date -->
          <div class="col-span-2">
            <label for="checkin" class="block text-sm font-medium mb-2">
              {t('reservations.checkIn')}
            </label>
            <input
              type="date"
              id="checkin"
              name="checkin"
              value={checkInDate}
              min={checkInDate}
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-hotel-accent"
            />
          </div>

          <!-- Adults -->
          <div>
            <label for="adults" class="block text-sm font-medium mb-2">
              {t('reservations.adults')}
            </label>
            <select
              id="adults"
              name="adults"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-hotel-accent"
            >
              {Array.from({ length: siteConfig.maxGroupSize || 8 }, (_, i) => i + 1).map(num => (
                <option value={num} selected={num === 2}>{num}</option>
              ))}
            </select>
          </div>
        </div>

        <!-- Second Row: More options -->
        <div class="grid grid-cols-3 gap-4">
          <!-- Check-out Date -->
          <div class="col-span-2">
            <label for="checkout" class="block text-sm font-medium mb-2">
              {t('reservations.checkOut')}
            </label>
            <input
              type="date"
              id="checkout"
              name="checkout"
              value={checkOutDate}
              min={checkOutDate}
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-hotel-accent"
            />
          </div>

          <!-- Children -->
          <div>
            <label for="children" class="block text-sm font-medium mb-2">
              {t('reservations.children')}
            </label>
            <select
              id="children"
              name="children"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-hotel-accent"
            >
              {Array.from({ length: siteConfig.maxGroupSize || 8 + 1 }, (_, i) => i).map(num => (
                <option value={num} selected={num === 0}>{num}</option>
              ))}
            </select>
          </div>
        </div>
      </div>

      <!-- Third Row: Toggles -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
        <Toggle
          label={t('reservations.breakfast')}
          name="breakfast"
          client:load
        />
        <Toggle
          label={t('reservations.vehicle')}
          name="vehicle"
          client:load
        />
        <Toggle
          label={t('reservations.specialRequest')}
          name="specialRequest"
          client:load
        />
      </div>

      <!-- Children Ages (shown when children > 0) -->
      <div id="children-ages" class="mt-6 hidden">
        <label class="block text-sm font-medium mb-2">
          {t('reservations.childrenAges')}
        </label>
        <div id="children-ages-container" class="flex flex-wrap gap-2">
          <!-- Dynamic children age inputs will be added here -->
        </div>
      </div>

      <!-- Submit Button -->
      <div class="text-center mt-8">
        <Button
          type="submit"
          variant="secondary"
          size="lg"
          class="px-8 py-3"
        >
          {t('reservations.searchRooms')}
        </Button>
      </div>
    </form>
  </div>
</section>

<script>
  // Handle children age inputs
  const childrenSelect = document.getElementById('children') as HTMLSelectElement;
  const childrenAgesContainer = document.getElementById('children-ages-container');
  const childrenAgesSection = document.getElementById('children-ages');

  function updateChildrenAges() {
    const childrenCount = parseInt(childrenSelect.value);

    if (childrenAgesContainer && childrenAgesSection) {
      if (childrenCount > 0) {
        childrenAgesSection.classList.remove('hidden');
        childrenAgesContainer.innerHTML = '';

        for (let i = 0; i < childrenCount; i++) {
          const ageInput = document.createElement('select');
          ageInput.name = `childAge${i}`;
          ageInput.className = 'px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-hotel-accent';

          // Add age options from 0 to 17
          for (let age = 0; age <= 17; age++) {
            const option = document.createElement('option');
            option.value = age.toString();
            option.textContent = `${age} ${age === 1 ? 'año' : 'años'}`;
            ageInput.appendChild(option);
          }

          childrenAgesContainer.appendChild(ageInput);
        }
      } else {
        childrenAgesSection.classList.add('hidden');
      }
    }
  }

  if (childrenSelect) {
    childrenSelect.addEventListener('change', updateChildrenAges);
    updateChildrenAges(); // Initialize on load
  }

  // Form submission
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      // In a real app, this would submit to the booking system
      console.log('Reservation form submitted');

      // Show success message or redirect to booking page
      alert('Funcionalidad de reservas próximamente disponible');
    });
  }
</script>