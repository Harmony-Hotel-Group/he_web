---
// src/components/media/VisualResource.astro
/**
 * Componente principal que delega a subcomponentes específicos
 * Solo carga el componente necesario para mejor performance
 */

import { logger } from "@/services/logger.ts";
import {
	detectResourceType,
	type ResourceType,
	validateResource,
} from "@/utils/visual-resource-utils.ts";
import ImageResource from "./ImageResource.astro";
import VideoResource from "./VideoResource.astro";
import YouTubeResource from "./YouTubeResource.astro";

const log = logger("VisualResource");

interface Props {
	src: string;
	type?: "image" | "video" | "youtube" | "auto";
	alt?: string;
	classes?: string;
	loading?: "lazy" | "eager";
	width?: number;
	height?: number;
	autoplay?: boolean;
	loop?: boolean;
	muted?: boolean;
	controls?: boolean;
	placeholder?: string;
	poster?: string;
	srcset?: string;
	sizes?: string;
}

const {
	src,
	type = "auto",
	alt = "",
	classes = "",
	loading = "lazy",
	width = 600,
	height = 400,
	autoplay = false,
	loop = false,
	muted = true,
	controls = true,
	placeholder,
	poster,
	srcset,
	sizes,
} = Astro.props;

const PlaceHolder =
	placeholder ||
	`https://placehold.co/${width}x${height}?text=Recurso+No+Encontrado`;

// Detectar tipo de recurso
const detectedType: ResourceType =
	type === "auto" ? detectResourceType(src) : (type as ResourceType);

log.info(
	`Recurso: ${src} | Tipo recibido: ${type} | Tipo detectado: ${detectedType}`,
);

// Validar recurso (solo en build time, no en runtime)
const validation = await validateResource(src, detectedType);

if (!validation.isValid) {
	log.warn(
		`Recurso no válido o no encontrado: '${src}'. Usando placeholder. Razón: ${validation.reason}`,
	);
}
---

{!src || !validation.isValid ? (
<ImageResource
        src={PlaceHolder}
        alt={alt || 'Recurso no encontrado'}
/>) :
    (detectedType === 'youtube') ? (
    <YouTubeResource
            src={src}
            classes={classes}
            autoplay={autoplay}
            loop={loop}
            muted={muted}
            controls={controls}
            title={alt}
    />
        ) : detectedType === 'video' ? (
    <VideoResource
            src={src}
            classes={classes}
            width={width}
            height={height}
            autoplay={autoplay}
            loop={loop}
            muted={muted}
            controls={controls}
            poster={poster}
            placeholder={placeholder}
    />
        ) : (
    <ImageResource
            src={src}
            alt={alt}
            width={width}
            height={height}
            loading={loading}
            classes={classes}
            srcset={srcset}
            sizes={sizes}
    />
        )}
