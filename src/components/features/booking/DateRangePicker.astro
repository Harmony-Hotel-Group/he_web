---
// src/components/features/booking/DateRangePicker.astro

interface Props {
    t: (key: string) => string;
    lang?: string;
}

const { t, lang = 'es' } = Astro.props;
---

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<div class="relative w-full">
    <label for="date-range-picker" class="block mb-1 text-sm font-medium text-gray-700">
        {t('booking.dateRangePicker')}
    </label>
    <div class="relative">
        <input
            id="date-range-picker"
            type="text"
            data-lang={lang}
            placeholder={t('booking.dateRangePlaceholder') || "Select a date range"}
            readonly
            class="w-full p-2 border rounded-md cursor-pointer pl-10" 
        />
        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
             <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                <line x1="16" x2="16" y1="2" y2="6"/>
                <line x1="8" x2="8" y1="2" y2="6"/>
                <line x1="3" x2="21" y1="10" y2="10"/>
            </svg>
        </div>
    </div>
    <input type="hidden" id="date-from-hidden" name="from" />
    <input type="hidden" id="date-to-hidden" name="to" />
</div>

<script>
    import flatpickr from "flatpickr";
    import { Spanish } from "flatpickr/dist/l10n/es.js";

    function initializeFlatpickr() {
        const dateInput = document.getElementById("date-range-picker");

        // Exit if input not found or already initialized
        if (!dateInput || (dateInput as any)._flatpickr) {
            return;
        }

        const dateFromInput = document.getElementById("date-from-hidden") as HTMLInputElement;
        const dateToInput = document.getElementById("date-to-hidden") as HTMLInputElement;
        const lang = (dateInput as HTMLElement).dataset.lang || "es";

        flatpickr(dateInput, {
            mode: "range",
            minDate: "today",
            dateFormat: "Y-m-d",
            locale: lang === "es" ? Spanish : undefined,
            numberOfMonths: 2,
            appendTo: document.body, // Crucial for visibility
            altInput: true,
            altFormat: "M j, Y",

            onChange: function (selectedDates, dateStr, instance) {
                if (selectedDates.length === 2) {
                    const [start, end] = selectedDates.sort((a, b) => a.getTime() - b.getTime());

                    if (start.getTime() === end.getTime()) {
                        instance.clear();
                        return;
                    }

                    // Update hidden inputs for form submission
                    if (dateFromInput) dateFromInput.value = instance.formatDate(start, "Y-m-d");
                    if (dateToInput) dateToInput.value = instance.formatDate(end, "Y-m-d");

                    // Update visible input with a user-friendly format
                    const nights = Math.round((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));
                    const nightsLabel = lang === "es"
                        ? `${nights} ${nights === 1 ? "noche" : "noches"}`
                        : `${nights} ${nights === 1 ? "night" : "nights"}`;
                    
                    instance.altInput.value = `${instance.formatDate(start, "M j")} - ${instance.formatDate(end, "M j")} (${nightsLabel})`;
                } else {
                    // Clear hidden inputs if range is not complete
                    if (dateFromInput) dateFromInput.value = "";
                    if (dateToInput) dateToInput.value = "";
                }
            },
        });
    }

    // Use the canonical Astro event. This runs on initial page load AND subsequent navigations.
    document.addEventListener('astro:page-load', initializeFlatpickr);
</script>
