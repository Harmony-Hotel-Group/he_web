---
import type { ImageMetadata } from "astro";
import VisualResource from "@/components/molecules/media/VisualResource.astro";
import { logger } from "@/services/logger.ts";

const log = logger("PhotoCollage");

interface Image {
    src: string | ImageMetadata;
    alt: string;
}

interface Props {
    images: Image[];
    class?: string;
}

const { images = [], class: className } = Astro.props;

log.info("Props recibidas:", { numImages: images.length });

// Validar y filtrar imágenes válidas
const validImages = images.filter((img) => img.src && img.alt);
const imagesToDisplay = validImages.slice(0, 5);

if (validImages.length === 0) {
	log.warn("No hay imágenes válidas para mostrar en el collage");
}

// Configuración mejorada de transformaciones con valores responsivos
const imageConfigs = [
    {
        rotation: "-rotate-6 hover:rotate-[-8deg]",
        position:
            "top-[5%] left-[10%] sm:top-[8%] sm:left-[5%] md:top-[10%] md:left-[8%]",
        zIndex: "z-1",
        delay: "0s",
    },
    {
        rotation: "rotate-3 hover:rotate-[5deg]",
        position:
            "top-[15%] right-[8%] sm:top-[12%] sm:right-[10%] md:top-[8%] md:right-[12%]",
        zIndex: "z-2",
        delay: "0.1s",
    },
    {
        rotation: "rotate-12 hover:rotate-15",
        position:
            "bottom-[8%] left-[15%] sm:bottom-[10%] sm:left-[12%] md:bottom-[12%] md:left-[10%]",
        zIndex: "z-3",
        delay: "0.2s",
    },
    {
        rotation: "-rotate-2 hover:rotate-[-4deg]",
        position:
            "top-[25%] left-[25%] sm:top-[22%] sm:left-[28%] md:top-[20%] md:left-[30%]",
        zIndex: "z-4",
        delay: "0.3s",
    },
    {
        rotation: "rotate-8 hover:rotate-11",
        position:
            "bottom-[18%] right-[12%] sm:bottom-[15%] sm:right-[15%] md:bottom-[18%] md:right-[18%]",
        zIndex: "z-5",
        delay: "0.4s",
    },
];
---

<!-- CONTENEDOR PRINCIPAL -->
<div
    class:list={[
        "relative w-full overflow-hidden",
        "min-h-[400px] sm:min-h-[450px] md:min-h-[500px] lg:min-h-[550px]",
        "flex justify-center items-center",
        "px-4 sm:px-6 md:px-8",
        className,
    ]}
>
    <!-- Contenedor del collage con aspect ratio -->
    <div class="relative w-full max-w-[900px] aspect-4/3 md:aspect-16/10">
        {imagesToDisplay.length > 0 ? (
            imagesToDisplay.map((image, index) => {
                const config = imageConfigs[index % imageConfigs.length];
                return (
                    <div
                        class:list={[
                            // Posicionamiento absoluto
                            "absolute",
                            config.position,
                            config.zIndex,

                            // Tamaños responsivos más controlados
                            "w-[45%] aspect-4/3",
                            "sm:w-[42%]",
                            "md:w-[38%]",
                            "lg:w-[35%]",

                            // Estilo de polaroid (borde mínimo)
                            "p-0",
                            "bg-white dark:bg-gray-800",
                            "shadow-[0_4px_20px_rgba(0,0,0,0.15)] dark:shadow-[0_4px_20px_rgba(0,0,0,0.4)]",
                            "rounded-xs",

                            // Rotación y transformaciones
                            config.rotation,
                            "origin-center",

                            // Transiciones y efectos hover
                            "transition-all duration-300 ease-out",
                            "hover:scale-110 hover:shadow-[0_8px_30px_rgba(0,0,0,0.25)]",
                            "hover:z-100",

                            // Cursor
                            "cursor-pointer",
                            
                            // Eliminar overflow para evitar bordes
                            "overflow-hidden",
                            
                            // Clase para la animación
                            "photo-throw-in",
                        ]}
                        style={`animation-delay: ${config.delay};`}
                        data-collage-image
                    >
                        <VisualResource
                            src={image.src}
                            alt={image.alt}
                            type="image"
                            class:list={[
                                "w-full h-full object-cover rounded-xs",
                                "transition-opacity duration-300",
                                "opacity-90 hover:opacity-100",
                            ]}
                        />
                    </div>
                );
            })
        ) : (
            <div class="absolute inset-0 flex items-center justify-center text-gray-400">
                <p class="text-center">No hay imágenes disponibles</p>
            </div>
        )}
    </div>
</div>

<style>
    /* Animación de lanzamiento de tarjetas */
    @keyframes throwIn {
        0% {
            opacity: 0;
            transform: translate(-100vw, -100vh) rotate(-180deg) scale(0.5);
        }
        60% {
            opacity: 1;
            transform: translate(0, 0) rotate(var(--rotation-overshoot, 0deg)) scale(1.1);
        }
        80% {
            transform: translate(0, 0) rotate(var(--rotation-back, 0deg)) scale(0.95);
        }
        100% {
            opacity: 1;
            transform: translate(0, 0) rotate(0deg) scale(1);
        }
    }
    
    .photo-throw-in {
        animation: throwIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        opacity: 0;
    }
    
    /* Variaciones de overshoot para cada rotación */
    .photo-throw-in:nth-child(1) {
        --rotation-overshoot: -8deg;
        --rotation-back: -4deg;
    }
    
    .photo-throw-in:nth-child(2) {
        --rotation-overshoot: 5deg;
        --rotation-back: 2deg;
    }
    
    .photo-throw-in:nth-child(3) {
        --rotation-overshoot: 15deg;
        --rotation-back: 10deg;
    }
    
    .photo-throw-in:nth-child(4) {
        --rotation-overshoot: -4deg;
        --rotation-back: -1deg;
    }
    
    .photo-throw-in:nth-child(5) {
        --rotation-overshoot: 11deg;
        --rotation-back: 6deg;
    }

    /* Asegurar que las imágenes no se salgan en pantallas muy pequeñas */
    @media (max-width: 380px) {
        div[class*="aspect-"] > div {
            width: 48% !important;
        }
    }
    
    /* Eliminar bordes negros y fondos del wrapper de ImageResource en el collage */
    [data-collage-image] :global(.image-resource-wrapper) {
        background: transparent !important;
        width: 100% !important;
        height: 100% !important;
        overflow: hidden !important;
        border: none !important;
    }
    
    [data-collage-image] :global(.image-resource),
    [data-collage-image] :global(img) {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        object-position: center !important;
        display: block !important;
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        outline: none !important;
        vertical-align: top !important;
    }
    
    /* Asegurar que las imágenes llenen completamente el contenedor sin espacios */
    [data-collage-image] {
        line-height: 0 !important;
    }
    
    /* Asegurar que el skeleton no muestre fondo */
    [data-collage-image] :global(.image-skeleton) {
        background: transparent !important;
    }
    
    /* Eliminar cualquier espacio o padding que pueda crear bordes */
    [data-collage-image] :global(*) {
        box-sizing: border-box;
        line-height: 0;
    }
    
    /* Reducir animación en dispositivos con prefer-reduced-motion */
    @media (prefers-reduced-motion: reduce) {
        .photo-throw-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
    }
</style>