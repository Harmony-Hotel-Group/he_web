---
// src/components/atoms/Switch.astro
interface Props {
    id?: string;
    name: string;

    checked?: boolean;
    disabled?: boolean;
    classes?: string;
}

const {
    id,
    name,

    checked = false,
    disabled = false,
    classes,
} = Astro.props;
---

<div class:list={["relative inline-block", classes]}>
    <button
            type="button"
            role="switch"
            aria-checked={checked}
            data-switch-button="true"
            data-name={name}
            class:list={[
                'relative inline-flex items-center h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out',
                'focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2',
                checked ? 'bg-accent' : 'bg-gray-200',
                disabled ? 'opacity-50 cursor-not-allowed' : ''
            ]}
            disabled={disabled}
    >
        <span
                aria-hidden="true"
                class:list={[
                    'pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out',
                    checked ? 'translate-x-5' : 'translate-x-0'
                ]}
        ></span>
    </button>
    <input type="hidden" name={name} value={checked.toString()}/>

    <script is:inline>
        // This script runs immediately for each instance of the component
        (() => {
            // Find the parent div of this script tag
            const scriptTag = document.currentScript;
            if (!scriptTag) return;

            const container = scriptTag.closest('div'); // Find the closest parent div
            if (!container) {
                return;
            }

            const switchButton = container.querySelector('button[role="switch"]');
            const hiddenInput = container.querySelector('input[type="hidden"]');

            if (!switchButton || !hiddenInput) {
                return;
            }

            // Prevent re-initialization
            if (switchButton.dataset.initialized) {
                return;
            }
            switchButton.dataset.initialized = 'true';

            switchButton.addEventListener('click', () => {
                let isChecked = switchButton.getAttribute('aria-checked') === 'true';
                isChecked = !isChecked; // Flip the state

                switchButton.setAttribute('aria-checked', String(isChecked));
                hiddenInput.value = String(isChecked);

                switchButton.classList.toggle('bg-accent', isChecked);
                switchButton.classList.toggle('bg-gray-200', !isChecked);

                const handle = switchButton.querySelector('span[aria-hidden="true"]');
                if (handle) {
                    handle.classList.toggle('translate-x-5', isChecked);
                    handle.classList.toggle('translate-x-0', !isChecked);
                } else {
                    console.error("[Switch.astro] Script: Handle element not found for instance.");
                }
            });
        })();
    </script>
</div>
