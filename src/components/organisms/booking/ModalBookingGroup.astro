---
import { Translations } from "~/i18n/translation.ts";
// src/components/organisms/booking/ModalBookingGroup.astro
import BookingGroupForm from "./BookingGroupForm.astro";
import BookingVehicleForm from "./BookingVehicleForm.astro";

interface Props {
	lang: string;
	config: any;
	isOpen: boolean;
}

const { lang, config, isOpen } = Astro.props;
const t = Translations(lang);
---

<div id="groupModal"
     class={`fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
    <div class={`bg-white dark:bg-gray-900 rounded-lg shadow-xl w-[80vw] h-[70vh] flex flex-col overflow-hidden transform transition-transform duration-300 ${isOpen ? 'scale-100 translate-y-0' : 'scale-95 translate-y-4'}`}>

        <div class="bg-primary text-white px-6 py-4 flex justify-between items-center flex-shrink-0">
            <h2 class="text-xl font-semibold flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                {t('booking.group.modal.title')}
            </h2>
        </div>

        <div id="modalBody" class="flex-1 overflow-y-auto p-6 bg-gray-50">
            <BookingGroupForm lang={lang} config={config}/>
            <div id="vehicleFormContainer" class="hidden mt-4">
                <BookingVehicleForm lang={lang} config={config}/>
            </div>
        </div>

        <div class="bg-white px-6 py-4 flex justify-end gap-3 border-t border-gray-200 flex-shrink-0">
            <button id="cancelModalBtn"
                    class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-md transition-colors duration-200 font-medium">{t('booking.group.modal.cancel')}</button>
            <button id="confirmModalBtn"
                    class="px-6 py-2 bg-accent hover:bg-accent/90 text-white rounded-md transition-colors duration-200 font-medium flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
                {t('booking.group.modal.confirm')}
            </button>
        </div>
    </div>
</div>

<script>
    class ModalBookingGroup {
        private modal: HTMLElement;
        private cancelBtn: HTMLElement;
        private confirmBtn: HTMLElement;
        private vehicleFormContainer: HTMLElement;
        private vehicleSwitchButton: HTMLButtonElement | null = null;
        private isOpen: boolean = false;

        constructor() {
            this.modal = document.getElementById('groupModal')!;
            this.cancelBtn = document.getElementById('cancelModalBtn')!;
            this.confirmBtn = document.getElementById('confirmModalBtn')!;
            this.vehicleFormContainer = document.getElementById('vehicleFormContainer')!;
            this.initEventListeners();
            this.setupSwitchObserver();
        }

        private initEventListeners() {
            this.cancelBtn.addEventListener('click', () => this.close());
            this.confirmBtn.addEventListener('click', async () => await this.confirm());
        }

        private setupSwitchObserver() {
            const findAndObserveSwitch = () => {
                const switchButton = this.modal.querySelector('button[data-name="vehicle"]') as HTMLButtonElement;
                if (switchButton && !this.vehicleSwitchButton) {
                    this.vehicleSwitchButton = switchButton;
                    const switchObserver = new MutationObserver(() => this.toggleVehicleForm());
                    switchObserver.observe(switchButton, {attributes: true, attributeFilter: ['aria-checked']});
                    this.toggleVehicleForm(); // Initial check
                    return true;
                }
                return false;
            };

            if (findAndObserveSwitch()) return;

            const modalObserver = new MutationObserver((_, obs) => {
                if (findAndObserveSwitch()) obs.disconnect();
            });
            modalObserver.observe(this.modal, {childList: true, subtree: true});
        }

        private toggleVehicleForm() {
            if (!this.vehicleSwitchButton) return;
            const isChecked = this.vehicleSwitchButton.getAttribute('aria-checked') === 'true';
            this.vehicleFormContainer.classList.toggle('hidden', !isChecked);
        }

        public open() {
            this.isOpen = true;
            this.modal.classList.remove('opacity-0', 'pointer-events-none');
            const modalContainer = this.modal.querySelector('.w-\[80vw\]') as HTMLElement;
            modalContainer.classList.remove('scale-95', 'translate-y-4');
            modalContainer.classList.add('scale-100', 'translate-y-0');
            this.modal.focus();
            this.syncDateFromMainForm();
        }

        public close() {
            this.isOpen = false;
            this.clearValidationErrors();
            const modalContainer = this.modal.querySelector('.w-\[80vw\]') as HTMLElement;
            modalContainer.classList.add('scale-95', 'translate-y-4');
            modalContainer.classList.remove('scale-100', 'translate-y-0');
            setTimeout(() => this.modal.classList.add('opacity-0', 'pointer-events-none'), 300);

            if (this.vehicleSwitchButton && this.vehicleSwitchButton.getAttribute('aria-checked') === 'true') {
                this.vehicleSwitchButton.click();
            }
        }

        private syncDateFromMainForm() {
            const mainDateInput = document.getElementById('dateRange') as HTMLInputElement;
            const groupDateInput = document.getElementById('dateRangeGroup') as HTMLInputElement;
            if (mainDateInput?.value && groupDateInput) {
                groupDateInput.value = mainDateInput.value;
            }
        }

        private clearValidationErrors() {
            this.modal.querySelectorAll('[id^="error_"]').forEach(el => el.classList.add('hidden'));
            this.modal.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
        }

        private handleValidationErrors(errors) {
            for (const fieldError of errors) {
                const fieldName = fieldError.path[0];
                const inputElement = this.modal.querySelector(`[name="${fieldName}"]`);
                const errorElement = this.modal.querySelector(`#error_${fieldName}`);

                if (inputElement) {
                    inputElement.classList.add('border-red-500');
                }
                if (errorElement) {
                    errorElement.textContent = fieldError.message;
                    errorElement.classList.remove('hidden');
                }
            }
        }

        private async confirm() {
            this.clearValidationErrors();
            try {
                const groupForm = document.getElementById('booking-group-form') as HTMLFormElement;
                const formData = new FormData(groupForm);
                const isVehicleChecked = this.vehicleSwitchButton?.getAttribute('aria-checked') === 'true';

                if (isVehicleChecked) {
                    const vehicleForm = this.vehicleFormContainer.querySelector('form');
                    if (vehicleForm) {
                        const vehicleFormData = new FormData(vehicleForm);
                        for (const [key, value] of vehicleFormData.entries()) {
                            formData.append(key, value);
                        }
                    }
                }

                const { sendBookingMessage } = await import('~/utils/send/index.ts');
                const type = isVehicleChecked ? 'vehicle' : 'group';
                await sendBookingMessage(formData, type);

                this.close();
                window.showToast('Reserva confirmada con éxito', 'success');

            } catch (error) {
                if (error.name === 'ActionInputError' && error.fields) {
                    this.handleValidationErrors(error.fields);
                    window.showToast('Por favor, revisa los campos del formulario.', 'error');
                } else {
                    console.error('Error al confirmar reserva:', error);
                    window.showToast('Error al procesar la reserva. Por favor, inténtelo de nuevo.', 'error');
                }
            }
        }
    }

    (window as any).ModalBookingGroup = ModalBookingGroup;
</script>