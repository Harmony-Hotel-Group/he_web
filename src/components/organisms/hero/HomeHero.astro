---
// src/components/organisms/hero/HomeHero.astro
import VisualResource from "@/components/molecules/media/VisualResource.astro";
import VisualCarousel from "@/components/organisms/carousel/VisualCarousel.astro";
import { logger } from "@/services/logger.ts";
import {
	detectResourceType,
	validateResource,
} from "@/utils/visual-resource-utils.ts";
import type { Resource } from "@/types/resource";

const log = logger("HomeHero");

interface Props {
	resources: Resource[];
	prioritizeVideo?: boolean;
}

const { resources = [], prioritizeVideo = true } = Astro.props;

log.info("Props recibidas:", {
	numResources: resources.length,
	prioritizeVideo,
});

const defaultPlaceholderResources: Resource[] = [
	{
		src: "https://placehold.co/1920x1080/1a1a1a/ffffff?text=Slide+1",
		type: "image",
		alt: "Placeholder 1",
	},
	{
		src: "https://placehold.co/1920x1080/2a2a2a/ffffff?text=Slide+2",
		type: "image",
		alt: "Placeholder 2",
	},
	{
		src: "https://placehold.co/1920x1080/3a3a3a/ffffff?text=Slide+3",
		type: "image",
		alt: "Placeholder 3",
	},
];

const userAgent = Astro.request.headers.get("user-agent") || "";
const isMobileDevice = /Mobile|Android|iPhone|iPad|iPod|Windows Phone/i.test(
	userAgent,
);

let validatedResources: Resource[] = [];
if (resources && resources.length > 0) {
	for (const res of resources) {
		const type =
			!res.type || res.type === "auto" ? detectResourceType(res.src) : res.type;
		const validation = await validateResource(res.src, type);
		if (validation.isValid) {
			validatedResources.push({ ...res, type });
		}
	}
}

if (validatedResources.length === 0) {
	validatedResources = defaultPlaceholderResources;
}

const videos = validatedResources.filter((r) => r.type === "video");
const youtubeVideos = validatedResources.filter((r) => r.type === "youtube");
const images = validatedResources.filter((r) => r.type === "image");

let finalResources: Resource[];
let displayMode: "video" | "carousel" = "carousel";

if (prioritizeVideo && !isMobileDevice) {
	if (youtubeVideos.length > 0) {
		finalResources = [youtubeVideos[0]];
		displayMode = "video";
	} else if (videos.length > 0) {
		finalResources = [videos[0]];
		displayMode = "video";
	} else {
		finalResources = images.length > 0 ? images : defaultPlaceholderResources;
	}
} else {
	finalResources = images.length > 0 ? images : defaultPlaceholderResources;
}

log.info(
	`Modo de visualizaciÃ³n: ${displayMode}. Recursos finales:`,
	finalResources.map((r) => r.src),
);
---

{displayMode === 'video' ? (
<div class="relative w-full min-h-[100dvh] overflow-hidden">
    <VisualResource
            src={finalResources[0].src}
            type={finalResources[0].type}
            alt={finalResources[0].alt}
            autoplay={true}
            loop={true}
            muted={true}
            controls={false}
            classes="absolute inset-0 w-full h-full object-cover"
    />
    <div class="absolute inset-0 z-10 pointer-events-none bg-black/50"></div>
</div>
    ) : (
<VisualCarousel resources={finalResources}/>
<div class="absolute inset-0 z-10 pointer-events-none bg-black/50"></div>
    )}
