---
interface Props {
    id: string;
    lang?: string;
    name?: string;
    placeholder?: string;
}

const {
    id,
    name,
    lang,
    placeholder
} = Astro.props;
---

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"/>

<style>
    .date-range-picker-input {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<div class="relative w-full">
    <input
            id={id}
            name={name}
            type="text"
            data-lang={lang}
            data-for-id={id}
            placeholder=`${placeholder}`
            readonly
            class="w-full p-2 border rounded-md cursor-pointer date-range-picker-input"
    />
</div>

<script>
    import flatpickr from "flatpickr";
    import "flatpickr/dist/l10n/es.js";
    import { defaultLang, Translations } from "~/i18n/translation.ts";

    function runDatePicker(input) {
        const lang = input.dataset.lang || defaultLang;
        const t = Translations(lang);

        flatpickr(input, {
            mode: "range",
            minDate: "today",
            dateFormat: "Y/m/d",
            locale: flatpickr.l10ns[lang] ?? flatpickr.l10ns.default,

            onChange: function (selectedDates, dateStr, instance) {
                if (selectedDates.length === 0) {
                    input.value = "";
                    input.removeAttribute("title");
                    return;
                }

                const formatDate = (d) => {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, "0");
                    const day = String(d.getDate()).padStart(2, "0");
                    return `${y}/${m}/${day}`;
                };

                if (selectedDates.length === 1) {
                    input.value = formatDate(selectedDates[0]);
                    input.title = input.value;
                }
                if (selectedDates.length === 2) {
                    const [start, end] = selectedDates;

                    if (start.toDateString() === end.toDateString()) {
                        instance.clear();
                        const message =
                            lang === "es"
                                ? "Debes seleccionar al menos 2 días diferentes."
                                : "You must select at least 2 different days.";
                        alert(message);
                        return;
                    }

                    const nights = Math.round((end - start) / (1000 * 60 * 60 * 24));

                    const nightsLabel = `${t('components.dateRangePicker', {n: nights, s: nights === 1 ? "" : "s"})}`
                    // lang === "es"
                    //     ? `${nights} ${nights === 1 ? "noche" : "noches"}`
                    //     : `${nights} ${nights === 1 ? "night" : "nights"}`;

                    const text = `${formatDate(start)} ➜ ${formatDate(end)} (${nightsLabel})`;

                    input.value = text;
                    input.title = text;
                }
            },
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        const inputs = document.querySelectorAll('input[data-for-id]');
        inputs.forEach(input => {
            console.log("input", input);
            runDatePicker(input);
        });
    });
</script>
