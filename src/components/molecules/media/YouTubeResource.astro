---
// src/components/media/YouTubeResource.astro
/**
 * Componente especializado para videos de YouTube
 * Soporta autoplay y prevención de pausa
 **/

import {
    getYouTubeEmbedUrl,
    extractYouTubeId,
} from "@/utils/visual-resource-utils.ts";
import { logger } from "@/services/logger.ts";

const log = logger("YouTubeResource");

interface Props {
    videoid: string;
    title?: string;
    classes?: string;
    autoplay?: boolean;
    loop?: boolean;
    muted?: boolean;
    controls?: boolean;
}

const {
    videoid,
    title,
    classes = "",
    autoplay = false,
    loop = false,
    muted = true,
    controls = false,
} = Astro.props;

// Extraer el video ID si se pasa una URL completa
const videoId = extractYouTubeId(videoid) || videoid;

log.info(
    `[YouTubeResource] Video ID: ${videoId}, Title: ${title}, Classes: ${classes}, Autoplay: ${autoplay}, Loop: ${loop}, Muted: ${muted}, Controls: ${controls}`,
);

// Validar que tengamos un video ID válido
if (!videoId) {
    log.error("[YouTubeResource] No se pudo extraer el video ID de:", videoid);
}

// Generar URL de embed con parámetros
const embedUrl = videoId
    ? getYouTubeEmbedUrl(videoId, {
          autoplay,
          loop,
          muted,
          controls,
      })
    : "";
---

{
    videoId && embedUrl ? (
        <div
            class:list={["youtube-resource-wrapper", classes]}
            data-youtube-id={videoId}
        >
            <iframe
                id={`youtube-${videoId}`}
                class="youtube-iframe"
                src={embedUrl}
                title={title || "YouTube video player"}
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                loading="lazy"
            />
        </div>
    ) : (
        <div
            class:list={["youtube-resource-wrapper", classes]}
            style="display: flex; align-items: center; justify-content: center; color: #fff; background: #000; position: absolute; inset: 0;"
        >
            <p>Error: No se pudo cargar el video de YouTube</p>
        </div>
    )
}

<style>
    .youtube-resource-wrapper {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        height: 100% !important;
        overflow: hidden;
        background: #000;
    }

    .youtube-iframe {
        position: absolute;
        top: 50%;
        left: 50%;
        border: 0;
        z-index: 1;
        /* Centrar y hacer zoom para cubrir todo el espacio */
        transform: translate(-50%, -50%);
    }

    /* Asegurar que siempre cubra al menos el contenedor */
    .youtube-iframe {
        min-width: 100%;
        min-height: 100%;
    }

    /* Overlay para prevenir pausa cuando autoplay está activado */
    .youtube-resource-wrapper .youtube-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        cursor: default;
        background: transparent;
        /* Solo capturar eventos, no bloquear visualmente */
        pointer-events: auto;
        /* Asegurar que sea completamente transparente y no bloquee */
        opacity: 0.01; /* Mínima opacidad para que capture eventos pero sea invisible */
    }

    /* Permitir interacción solo si no es autoplay o si se necesita control */
    .youtube-resource-wrapper.allow-interaction .youtube-overlay {
        display: none;
    }
</style>

<script define:vars={{ videoId, autoplay, loop }}>
    /**
     * Control de video de YouTube con autoplay y prevención de pausa
     */

    // Logs en consola del navegador para debugging
    console.log(
        `[YouTubeResource-Client] Inicializando para video: ${videoId}, autoplay: ${autoplay}`,
    );

    document.addEventListener("DOMContentLoaded", () => {
        console.log(
            `[YouTubeResource-Client] DOMContentLoaded, buscando wrapper para: ${videoId}`,
        );
        const wrapper = document.querySelector(
            `[data-youtube-id="${videoId}"]`,
        );
        if (!wrapper) {
            console.error(
                `[YouTubeResource-Client] No se encontró el wrapper para video: ${videoId}`,
            );
            return;
        }

        const iframe = wrapper.querySelector("iframe");
        if (!iframe) {
            console.error(
                `[YouTubeResource-Client] No se encontró el iframe para video: ${videoId}`,
            );
            return;
        }

        // Función para ajustar dimensiones del iframe
        const adjustIframeSize = () => {
            // Usar dimensiones del contenedor (wrapper) en lugar del viewport
            const containerWidth = wrapper.offsetWidth;
            const containerHeight = wrapper.offsetHeight;
            const containerRatio = containerWidth / containerHeight;

            // Asegurar que el wrapper ocupe todo el espacio
            wrapper.style.position = "absolute";
            wrapper.style.top = "0";
            wrapper.style.left = "0";
            wrapper.style.right = "0";
            wrapper.style.bottom = "0";
            wrapper.style.width = "100%";
            wrapper.style.height = "100%";

            // Calcular dimensiones del iframe para cubrir toda la pantalla (COVER)
            // Lógica inversa a "contain": queremos que sobre, no que falte
            if (containerRatio > 16 / 9) {
                // Contenedor más ancho que 16:9 - el ancho manda, la altura sobrará (se recorta arriba/abajo)
                iframe.style.width = `${containerWidth}px`;
                iframe.style.height = `${containerWidth * (9 / 16)}px`;
            } else {
                // Contenedor más alto que 16:9 - la altura manda, el ancho sobrará (se recorta lados)
                iframe.style.height = `${containerHeight}px`;
                iframe.style.width = `${containerHeight * (16 / 9)}px`;
            }

            // Asegurar que siempre cubra al menos el contenedor (redundancia de seguridad)
            if (parseFloat(iframe.style.width) < containerWidth) {
                iframe.style.width = `${containerWidth}px`;
                iframe.style.height = `${containerWidth * (9 / 16)}px`;
            }
            if (parseFloat(iframe.style.height) < containerHeight) {
                iframe.style.height = `${containerHeight}px`;
                iframe.style.width = `${containerHeight * (16 / 9)}px`;
            }

            console.log(
                `[YouTubeResource-Client] Iframe ajustado (COVER CONTAINER):`,
                {
                    width: iframe.style.width,
                    height: iframe.style.height,
                    containerRatio,
                    containerWidth,
                    containerHeight,
                },
            );
        };

        // Ajustar dimensiones inmediatamente
        adjustIframeSize();

        // Ajustar dimensiones al redimensionar la ventana
        window.addEventListener("resize", adjustIframeSize);

        // Si autoplay está activado, prevenir pausa
        if (autoplay) {
            // Esperar un momento para que el iframe se renderice antes de agregar overlay
            setTimeout(() => {
                // Verificar que el iframe existe y está visible
                if (!iframe || !wrapper.contains(iframe)) return;

                // Crear overlay transparente para capturar clics y prevenir pausa
                const overlay = document.createElement("div");
                overlay.className = "youtube-overlay";
                wrapper.appendChild(overlay);

                // Prevenir eventos de clic en el overlay
                overlay.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                });

                overlay.addEventListener("mousedown", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                });

                overlay.addEventListener("contextmenu", (e) => {
                    e.preventDefault();
                    return false;
                });
            }, 500); // Esperar 500ms para que el iframe se renderice

            // Interceptar mensajes del iframe para prevenir pausa
            const messageHandler = (event) => {
                // Solo procesar mensajes del iframe de YouTube
                if (
                    event.origin !== "https://www.youtube.com" &&
                    event.origin !== "https://www.youtube-nocookie.com"
                ) {
                    return;
                }

                // Si el video se pausa, reanudarlo automáticamente
                if (event.data && typeof event.data === "string") {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.event === "onStateChange") {
                            // Estado 2 = pausado, Estado 1 = reproduciendo, Estado 0 = terminado
                            if (data.info === 2) {
                                // Reanudar reproducción enviando comando de play
                                iframe.contentWindow?.postMessage(
                                    JSON.stringify({
                                        event: "command",
                                        func: "playVideo",
                                        args: "",
                                    }),
                                    "*",
                                );
                            }
                        }
                    } catch (e) {
                        // Ignorar errores de parsing
                    }
                }
            };

            window.addEventListener("message", messageHandler);

            // Verificar periódicamente que el video esté reproduciéndose
            const checkInterval = setInterval(() => {
                try {
                    // Enviar comando para asegurar que el video siga reproduciéndose
                    iframe.contentWindow?.postMessage(
                        JSON.stringify({
                            event: "command",
                            func: "playVideo",
                            args: "",
                        }),
                        "*",
                    );
                } catch (e) {
                    // Ignorar errores de cross-origin
                }
            }, 2000); // Verificar cada 2 segundos

            // Limpiar cuando se desmonte el componente
            console.log(
                `[YouTubeResource-Client] Autoplay activado para video: ${videoId}`,
            );
        } else {
            // Si no es autoplay, permitir interacción normal
            wrapper.classList.add("allow-interaction");
        }
    });
</script>
