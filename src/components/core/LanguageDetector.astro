---
// src/components/core/LanguageDetector.astro
---

<script>
    import type { Language } from '@/i18n/translation';
    import { getLangFromCookie, setLangCookie, defaultLang } from '@/i18n/translation';
    import { logger } from '@/services/logger.ts';
    const log = logger('LanguageDetector')

    function detectPreferredLanguage(): Language {
        log.warn('Iniciando Deteccion de Lenguaje')
        // 1. Verificar cookie
        const cookieLang = getLangFromCookie();
        log.info("Cargndo Cookie Lang",cookieLang)

        if (cookieLang) return cookieLang;

        // 2. Verificar navegador
        const browserLang = navigator.language.split('-')[0];
        log.info("Buscando en configuraciones de Navegador",browserLang)

        if (browserLang === 'en') return 'en';

        // 3. Default
        log.info('Devolviendo valor por defecto',defaultLang)
        return defaultLang;
    }

    const preferredLang = detectPreferredLanguage();
    const currentPath = window.location.pathname;
    const isEnglishPath = currentPath.startsWith('/en');

    // Sincronizar cookie con el idioma preferido
    setLangCookie(preferredLang);

    // Ocultar /en/ de la URL visible si estamos en una ruta en ingl√©s
    if (isEnglishPath) {
        const cleanPath = currentPath.replace(/^\/en/, '') || '/';
        const query = window.location.search || '';
        const hash = window.location.hash || '';
        history.replaceState({}, '', cleanPath + query + hash);
    }
</script>