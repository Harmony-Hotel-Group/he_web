---
// src/components/organisms/booking/BookingGroupForm.astro
import Label from "@/components/atoms/Label.astro";
import TextAreaInput from "@/components/atoms/TextAreaInput.astro";

import DatePickerField from "@/components/molecules/forms/DatePickerField.astro";
import NumberField from "@/components/molecules/forms/NumberField.astro";
import SwitchField from "@/components/molecules/forms/SwitchField.astro";

import BookingVehicleSection from "@/components/organisms/booking/BookingVehicleSection.astro";
import { Translations } from "@/i18n/translation.ts";
import Grid from "@/layouts/GridLayout.astro";
import Row from "@/layouts/Row.astro";

interface Props {
	lang: string;
	config: any;
}

const { lang, config } = Astro.props;
const t = Translations(lang);
---

<form id="booking-group-form" method="post" class="space-y-4">
    <div class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-3 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            {t('booking.group.title')}
        </h3>

        <Grid cols={3} autoAdjust={true} gap={4}>
            <!-- DatePicker sincronizado con el formulario principal -->
            <div data-col-span="full" data-col-span-md="full">
                <DatePickerField
                        fieldId="dateRangeGroup"
                        name="dateRangeGroup"
                        lblKey="booking.dateRange.title"
                        lang={lang}
                        syncGroup="booking"
                />
            </div>

            <NumberField
                    fieldId="groupAdults"
                    name="groupAdults"
                    lblKey="booking.group.adults"
                    lang={lang}
                    icon="form/adult"
                    min={1}
                    value={8}
            />

            <NumberField
                    fieldId="groupTeens"
                    name="groupTeens"
                    lblKey="booking.group.teens"
                    lang={lang}
                    icon="form/teen"
                    min={0}
            />

            <NumberField
                    fieldId="groupKids"
                    name="groupKids"
                    lblKey="booking.group.kids"
                    lang={lang}
                    icon="form/child"
                    min={0}
            />

            <NumberField
                    fieldId="groupInfants"
                    name="groupInfants"
                    lblKey="booking.group.infants"
                    lang={lang}
                    icon="form/baby"
                    min={0}
            />
        </Grid>
    </div>

    <Row>
        <SwitchField
                fieldId="breakfast"
                name="breakfast"
                lblKey="booking.switch.breakfast"
                lang={lang}
                checked
                icon="form/breakfast"
        />
        <SwitchField
                fieldId="vehicle-group"
                name="vehicle-group"
                lblKey="booking.group.vehicle"
                lang={lang}
                icon="form/vehicle"
        />
    </Row>

    <div id="special_request-group-section" class="hidden">
        <Label forId="groupNotes" lang={lang} lblKey="booking.group.notes" classes="pr-5"/>
        <TextAreaInput
                id="groupNotes"
                name="groupNotes"
                keyPlaceholder='booking.group.notesPlaceholder'
                lang={lang}
        />
    </div>

    <div id="vehicle-group-section" class="hidden">
        <BookingVehicleSection lang={lang} config={config} client:load/>
    </div>

</form>

<script>
    import { actions } from 'astro:actions';

    document.addEventListener('DOMContentLoaded', () => {
        const form: HTMLFormElement = document.getElementById('booking-group-form') as HTMLFormElement;
        if (!form) return;

        const vehicleSection = document.getElementById('vehicle-group-section');
        const vehicleSwitchButton = form.querySelector('button[id="vehicle-group"]');


        if (vehicleSwitchButton && vehicleSection) {
            const observer = new MutationObserver(() => {
                const isChecked = vehicleSwitchButton.getAttribute('aria-checked') === 'true';
                vehicleSection.classList.toggle('hidden', !isChecked);
            });
            observer.observe(vehicleSwitchButton, {
                attributes: true,
                attributeFilter: ['aria-checked']
            });
        }

        // Escuchar cambios en el date picker para validaciÃ³n
        const dateInput = document.getElementById('dateRangeGroup');

        dateInput?.addEventListener('datepicker:change', (event: any) => {
            const {nights, dates} = event.detail;

            if (import.meta.env.DEV) {
                console.log('[BookingGroupForm] Fechas cambiadas:', {
                    nights,
                    dates: dates.map((d: Date) => d.toLocaleDateString())
                });
            }
        });
    });
</script>

<style>
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        opacity: 1;
    }

    textarea {
        resize: vertical;
        min-height: 60px;
    }
</style>