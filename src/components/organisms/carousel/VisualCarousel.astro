---
// src/components/organisms/carousel/VisualCarousel.astro
import Imagen from "@/components/atoms/Imagen.astro";
import { logger } from "@/services/logger.ts";
import type { Resource } from "@/types/resource";
import { validateResource } from "@/utils/visual-resource-utils.ts";

interface Props {
	class?: string;
	maskOpacityClass?: string;
	autoplayInterval?: number;
	showIndicators?: boolean;
	showScrollIndicator?: boolean;
	resources?: Resource[];
	arrows?: boolean;
}

const {
	class: className = "",
	maskOpacityClass = "bg-black/50",
	autoplayInterval = 5000,
	showIndicators = true,
	showScrollIndicator = true,
	resources = [],
	arrows = false,
} = Astro.props;

const log = logger("VisualCarousel");

log.info("Props recibidas:", Astro.props);


const carouselId = `carousel-${String(Math.random().toString(36)).substring(2, 9)}`;
log.info(
	"Crecion de VisualCarousel con ID:",
	carouselId,
	",Cantidad de recursos:",
	resources.length,
	"y intervalo:",
	autoplayInterval,
	"ms",
);

// Validar recursos y filtrar los inválidos
const validatedResources = (
	await Promise.all(
		resources.map(async (item) => {
			const validation = await validateResource(item.src, "image");
			if (validation.isValid && validation.finalSrc) {
				return {
					...item,
					src: validation.finalSrc,
				};
			}
			log.warn(`Recurso inválido filtrado: ${typeof item.src === 'string' ? item.src : 'ImageMetadata'}`, validation.error);
			return null;
		}),
	)
).filter((item): item is Resource => item !== null);
---



<div
    class:list={[className, 'relative w-full min-h-[100dvh] overflow-hidden']}
    data-carousel-id={carouselId}
>


    <div class="absolute inset-0 w-full h-full" data-carousel-container>
        {validatedResources && validatedResources.length > 0 ? (
            validatedResources.map((item, index) => (
                <div class="absolute inset-0 w-full h-full transition-opacity duration-1000 ease-in-out opacity-0">
                    <Imagen
                        src={item.src}
                        alt={item.alt}
                        class="w-full h-full object-cover"
                        loading={index === 0 ? "eager" : "lazy"}
                        fetchpriority={index === 0 ? "high" : "auto"}
                     height={1080} width={1920}/>
                </div>
            ))
        ) : (
            <slot />
        )}
    </div>

    <!--&lt;!&ndash; Mask overlay &ndash;&gt;-->
    <!--<div class:list={['absolute inset-0 w-full h-full z-20', maskOpacityClass]}></div>-->

    <!-- Indicators (dots) -->
    {showIndicators && (
        <div class="absolute bottom-16 left-1/2 z-30 flex -translate-x-1/2 space-x-3" data-carousel-indicators></div>
    )}

    <!-- Navigation arrows -->
    {arrows && (
            <button
                    type="button"
                    class="absolute top-1/2 left-4 z-30 -translate-y-1/2 flex items-center justify-center w-12 h-12 rounded-full bg-white/20 hover:bg-white/30 backdrop-blur-sm transition-all group"
                    data-carousel-prev
                    aria-label="Slide anterior"
            >
                <svg class="w-6 h-6 text-white group-hover:scale-110 transition-transform" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <button
                    type="button"
                    class="absolute top-1/2 right-4 z-30 -translate-y-1/2 flex items-center justify-center w-12 h-12 rounded-full bg-white/20 hover:bg-white/30 backdrop-blur-sm transition-all group"
                    data-carousel-next
                    aria-label="Slide siguiente"
            >
                <svg class="w-6 h-6 text-white group-hover:scale-110 transition-transform"  stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
    )}

    <!-- Scroll Down Indicator -->
    {showScrollIndicator && (
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-30 animate-bounce cursor-pointer" data-scroll-indicator>
            <svg class="w-8 h-8 text-white drop-shadow-lg" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </div>
    )}
</div>

<script is:inline define:vars={{autoplayInterval, carouselId}}>
    document.addEventListener('DOMContentLoaded', () => {
        class VisualCarouselManager {
            constructor(carouselId, interval) {
                this.container = null;
                this.items = [];
                this.indicatorsContainer = null;
                this.indicators = [];
                this.currentIndex = 0;
                this.intervalId = null;
                this.init(carouselId, interval);
            }

            init(carouselId, interval) {
                const carousel = document.querySelector(`[data-carousel-id="${carouselId}"]`);
                if (!carousel) return;

                this.container = carousel.querySelector('[data-carousel-container]');
                if (!this.container) return;

                this.items = Array.from(this.container.children);
                this.indicatorsContainer = carousel.querySelector('[data-carousel-indicators]');

                if (this.items.length <= 1) {
                    carousel.querySelector('[data-carousel-prev]')?.remove();
                    carousel.querySelector('[data-carousel-next]')?.remove();
                    this.indicatorsContainer?.remove();
                    return;
                }

                this.createIndicators();
                this.initEventListeners(carousel);
                this.updateSlide(0);
                this.start(interval);
            }

            createIndicators() {
                if (!this.indicatorsContainer) return;
                this.items.forEach((_, index) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.classList.add('w-3', 'h-3', 'rounded-full', 'transition-all', 'duration-300');
                    button.setAttribute('aria-label', `Ir a slide ${index + 1}`);
                    button.dataset.slideTo = index.toString();
                    this.indicatorsContainer.appendChild(button);
                });
                this.indicators = Array.from(this.indicatorsContainer.children);
            }

            initEventListeners(carousel) {
                carousel.querySelector('[data-carousel-prev]')?.addEventListener('click', () => this.prev());
                carousel.querySelector('[data-carousel-next]')?.addEventListener('click', () => this.next());
                this.indicators.forEach(ind => ind.addEventListener('click', (e) => this.goToSlide(parseInt(e.target.dataset.slideTo || '0'))));
            }

            updateSlide(index) {
                this.items.forEach((item, i) => {
                    item.classList.toggle('opacity-100', i === index);
                    item.classList.toggle('opacity-0', i !== index);
                    item.classList.toggle('z-10', i === index);
                    item.classList.toggle('z-0', i !== index);
                });
                this.indicators.forEach((indicator, i) => {
                    indicator.classList.toggle('bg-white', i === index);
                    indicator.classList.toggle('w-8', i === index);
                    indicator.classList.toggle('bg-white/50', i !== index);
                    indicator.classList.toggle('w-3', i !== index);
                });
                this.currentIndex = index;
            }

            next() {
                this.goToSlide((this.currentIndex + 1) % this.items.length);
            }

            prev() {
                this.goToSlide((this.currentIndex - 1 + this.items.length) % this.items.length);
            }

            goToSlide(index) {
                this.updateSlide(index);
            }

            start(interval) {
                this.intervalId = window.setInterval(() => this.next(), interval);
            }
        }

        new VisualCarouselManager(carouselId, autoplayInterval);
    });
</script>
