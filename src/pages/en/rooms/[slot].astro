---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { api } from "@/services/api";
import type { SiteConfig } from "@/types/config";
import type { Room } from "@/types/rooms";

export const prerender = false;

// Obtener parámetros de la URL
const { slot } = Astro.params;
// Determinar idioma basado en URL
const lang: "es" | "en" = "en";

// Multi-fetch de configuration y rooms
const { config, rooms } = (await api.multiFetch({
	config: { params: { lang } },
	rooms: { params: { lang } },
})) as { config: SiteConfig; rooms: Room[] | Error | null };

// Safe lookup de la habitación
const safeRooms = Array.isArray(rooms) ? rooms : [];
const room = safeRooms.find((r) => r.id === slot);

// Redirect to 404 if room not found (in a real app, use Astro.redirect('/404'))
if (!room) {
	return new Response(null, {
		status: 404,
		statusText: "Not Found",
	});
}

const formatPrice = (price: number, currency: string) => {
	return new Intl.NumberFormat(lang === "en" ? "en-US" : "es-ES", {
		style: "currency",
		currency: currency,
		minimumFractionDigits: 0,
	}).format(price);
};
---

<BaseLayout titleKey={room.name[lang]} lang={lang} config={config}>
	<!-- Hero Section (Room specific) -->
	<div class="relative h-[60vh] min-h-[500px] w-full overflow-hidden">
		<div
			class="absolute inset-0 bg-gradient-to-t from-gray-900/80 via-transparent to-gray-900/30 z-10"
		>
		</div>
		<img
			src={room.images.find((img) => img.frontpage)?.src ||
				room.images[0].src}
			alt={room.name[lang]}
			class="w-full h-full object-cover transition-transform duration-1000 animate-slow-zoom"
		/>

		<div class="absolute bottom-0 left-0 right-0 z-20 p-8 md:p-12 lg:p-20">
			<div class="max-w-7xl mx-auto">
				<span
					class="inline-block bg-accent px-3 py-1 text-white text-xs font-bold tracking-[0.2em] uppercase mb-4 animate-fade-in-up"
				>
					{room.type[lang]}
				</span>
				<h1
					class="text-4xl md:text-6xl lg:text-7xl font-serif text-white font-bold mb-4 drop-shadow-xl animate-fade-in-up delay-100"
				>
					{room.name[lang]}
				</h1>
				<p
					class="text-xl md:text-2xl text-gray-200 font-light drop-shadow-md animate-fade-in-up delay-200"
				>
					{formatPrice(room.pricePerNight, room.currency)}
					<span class="text-base text-gray-300"
						>/ {lang === "es" ? "noche" : "night"}</span
					>
				</p>
			</div>
		</div>
	</div>

	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 lg:py-24">
		<div class="grid grid-cols-1 lg:grid-cols-3 gap-12 lg:gap-20">
			<!-- Left Column: Details & Gallery -->
			<div class="lg:col-span-2 space-y-12">
				<!-- Description -->
				<div>
					<h2
						class="text-2xl font-serif text-primary mb-6 flex items-center gap-4"
					>
						{lang === "es" ? "Descripción" : "Description"}
						<span class="h-px bg-gray-200 flex-grow"></span>
					</h2>
					<p class="text-gray-600 leading-loose text-lg font-light">
						{room.description[lang]}
					</p>
				</div>

				<!-- Amenities -->
				<div>
					<h2
						class="text-2xl font-serif text-primary mb-6 flex items-center gap-4"
					>
						{lang === "es" ? "Comodidades" : "Amenities"}
						<span class="h-px bg-gray-200 flex-grow"></span>
					</h2>
					<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
						{
							(room.amenities?.[lang] || []).map((amenity) => (
								<div class="flex items-center gap-3 text-gray-600 p-3 bg-gray-50 rounded-sm hover:bg-white hover:shadow-sm transition-all border border-transparent hover:border-gray-100">
									<svg
										class="w-5 h-5 text-accent"
										fill="none"
										stroke="currentColor"
										viewBox="0 0 24 24"
									>
										<path
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="M5 13l4 4L19 7"
										/>
									</svg>
									<span>{amenity}</span>
								</div>
							))
						}
					</div>
				</div>

				<!-- Extra Images Grid -->
				{
					room.images.length > 1 && (
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-8">
							{room.images
								.filter((img) => !img.frontpage)
								.map((img, index) => (
									<div
										class={`relative overflow-hidden rounded-sm aspect-video ${index === 0 ? "md:col-span-2 md:aspect-[2/1]" : ""}`}
									>
										<img
											src={img.src}
											alt={img.alt[lang]}
											class="w-full h-full object-cover hover:scale-105 transition-transform duration-700"
										/>
									</div>
								))}
						</div>
					)
				}
			</div>

			<!-- Right Column: Booking Card -->
			<div class="lg:col-span-1">
				<div
					class="sticky top-24 bg-white p-8 border border-gray-100 shadow-xl rounded-sm"
				>
					<h3
						class="text-xl font-serif text-primary mb-6 text-center"
					>
						{
							lang === "es"
								? "Reserva tu Estancia"
								: "Book Your Stay"
						}
					</h3>

					<div class="space-y-6">
						<!-- Check availability placeholder form -->
						<div class="space-y-4">
							<div>
								<label
									class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2"
									>{
										lang === "es" ? "Llegada" : "Check-in"
									}</label
								>
								<input
									type="date"
									class="w-full border-gray-200 rounded-sm focus:border-accent focus:ring-accent"
								/>
							</div>
							<div>
								<label
									class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2"
									>{
										lang === "es" ? "Salida" : "Check-out"
									}</label
								>
								<input
									type="date"
									class="w-full border-gray-200 rounded-sm focus:border-accent focus:ring-accent"
								/>
							</div>
						</div>

						<div class="border-t border-gray-100 pt-6">
							<div class="flex justify-between items-center mb-2">
								<span class="text-gray-500"
									>{
										lang === "es"
											? "Precio por noche"
											: "Price per night"
									}</span
								>
								<span class="text-xl font-bold text-primary"
									>{
										formatPrice(
											room.pricePerNight,
											room.currency,
										)
									}</span
								>
							</div>
						</div>

						<a
							href="/booking"
							class="block w-full bg-accent text-white text-center py-4 font-bold uppercase tracking-widest hover:bg-primary transition-colors duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
						>
							{
								lang === "es"
									? "Consultar Disponibilidad"
									: "Check Availability"
							}
						</a>

						<p
							class="text-xs text-center text-gray-400 mt-4 leading-relaxed"
						>
							{
								lang === "es"
									? "Mejor precio garantizado. Sin cargos ocultos."
									: "Best price guaranteed. No hidden fees."
							}
						</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</BaseLayout>

<style>
	@keyframes slow-zoom {
		from {
			transform: scale(1);
		}
		to {
			transform: scale(1.1);
		}
	}
	.animate-slow-zoom {
		animation: slow-zoom 20s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite
			alternate;
	}

	.animate-fade-in-up {
		animation: fade-in-up 0.8s ease-out forwards;
		opacity: 0;
		transform: translateY(20px);
	}

	.delay-100 {
		animation-delay: 0.1s;
	}
	.delay-200 {
		animation-delay: 0.2s;
	}

	@keyframes fade-in-up {
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>
