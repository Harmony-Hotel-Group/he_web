---
// index.astro

import BookingBar from "@/components/organisms/booking/BookingBar.astro";
import PhotoCollage from "@/components/organisms/collage/PhotoCollage.astro";
import HomeHero from "@/components/organisms/hero/HomeHero.astro";
import HomeSection from "@/components/organisms/home/HomeSection.astro";

import BaseLayout from "@/layouts/BaseLayout.astro";
import { api } from "@/services/api.ts";
import { logger } from "@/services/logger.ts";
import type { SiteConfig } from "@/types/config";

const log = logger("IndexPage");

// En el servidor, el idioma se determina por la cookie. 'es' es el valor por defecto.
const lang = Astro.cookies.get("lang")?.value || "es";
log.info("Idioma detectado en el servidor:", lang);

if (lang === "en") {
	// Si la cookie es 'en', Vercel ya debería haber reescrito a /en.
	// Esta redirección es una salvaguarda por si se accede directamente a la raíz.
	return Astro.redirect("/en", 302);
}

const config = (await api.fetch("config", { params: { lang } })) as SiteConfig;
//log.info("Datos de configuración (config) cargados:", config);

const carouselResources = config?.carouselResources || [];
log.info("Recursos para el carousel:", carouselResources);
---

<BaseLayout titleKey="site.title" lang={lang} config={config}>
    <!-- H1 accesible para SEO/a11y -->
    <h1 class="sr-only">{config?.aboutUs?.mainTitle?.[lang] ?? config?.siteName ?? 'Home'}</h1>
    <div class="relative w-full min-h-[100dvh] overflow-hidden">
        <HomeHero resources={carouselResources}/>
        <!-- Overlay de degradado para legibilidad del contenido superpuesto -->
        <!--<div class="pointer-events-none absolute inset-0 bg-gradient-to-b from-black/50 via-black/30 to-black/20"></div>-->
        <div class="absolute inset-0 z-10 flex items-center justify-center p-4">
            <div class="w-full max-w-6xl px-4 sm:px-6">
                <BookingBar lang={lang} config={config}/>
            </div>
        </div>
    </div>

    <div>
        <!-- About Us Section -->
        {config?.aboutUs && (
                <section class="py-20 md:py-24">
                    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-10 lg:gap-14 items-center">
                            <div class="text-center md:text-left">
                                <h3 class="text-base md:text-lg font-semibold text-accent mb-2 tracking-wide">{config.aboutUs.subtitle[lang]}</h3>
                                <h2 class="text-3xl md:text-4xl lg:text-5xl font-bold text-primary mb-4">{config.aboutUs.mainTitle[lang]}</h2>
                                <p class="text-gray-600 leading-relaxed mb-4 text-base md:text-lg">{config.aboutUs.welcomeParagraph[lang]}</p>
                                <p class="text-gray-600 leading-relaxed text-base md:text-lg">{config.aboutUs.commitmentParagraph[lang]}</p>
                            </div>
                            <div>
                                <PhotoCollage images={config.aboutUs.images}/>
                            </div>
                        </div>
                    </div>
                </section>
        )}

        <!-- Sections -->
        {config?.roomTypes && (
                <HomeSection
                        lang={lang}
                        titleKey="nav.rooms"
                        items={config.roomTypes}
                        baseHref="/rooms"
                        bgColorClass="bg-gray-100"
                        maxItems={4}
                />
        )}

        {config?.destinationCategories && (
                <HomeSection
                        lang={lang}
                        titleKey="nav.destinations"
                        items={config.destinationCategories}
                        baseHref="/destinations"
                        maxItems={4}
                />
        )}

        {config?.gastronomyCategories && (
                <HomeSection
                        lang={lang}
                        titleKey="nav.gastronomy"
                        items={config.gastronomyCategories}
                        baseHref="/gastronomy"
                        bgColorClass="bg-gray-100"
                        maxItems={4}
                />
        )}

        {config?.tourCategories && (
                <HomeSection
                        lang={lang}
                        titleKey="nav.tours"
                        items={config.tourCategories}
                        baseHref="/tours"
                        maxItems={4}
                />
        )}
    </div>
</BaseLayout>
