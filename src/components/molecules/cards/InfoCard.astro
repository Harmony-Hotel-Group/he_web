---
// src/components/molecules/cards/InfoCard.astro
import type { Currency } from "@/types/config";
// import type { LocalizedText } from "@/types/global";
import ImageResource from "@/components/molecules/media/ImageResource.astro";
import { logger } from "@/services/logger";

const log = logger("InfoCard");

interface Props {
	href: string;
	imageSrc: string;
	imageAlt: string;
	title: string;
	description: string;
	category?: string;
	tags?: string[];
	value: number;
	valueLabel?: string;
	supportedCurrencies: Currency[];
}

const {
	href,
	imageSrc,
	imageAlt,
	title, //
	description,
	category,
	tags = [],
	value,
	valueLabel = "Valor",
	supportedCurrencies = [],
} = Astro.props;

log.info("Props recibidas:", {
	href,
	imageSrc,
	imageAlt,
	title,
	description,
	category,
	tags,
	value,
	valueLabel,
	supportedCurrencies,
});

const safeDescription = description || "";
const truncatedDescription =
	safeDescription.length > 200
		? `${safeDescription.substring(0, 200)}...`
		: safeDescription;

const selectedCurrency = Astro.cookies.get("currency")?.value || "USD";
log.info("Currency selected:", Astro.cookies);

const baseCurrency = "USD";
log.info("Base currency:", baseCurrency);

const rates: Record<string, number> = (supportedCurrencies ?? []).reduce(
	(acc, currency) => {
		acc[currency.code] = currency.exchangeRate ?? 1;
		return acc;
	},
	{} as Record<string, number>,
);
log.info("Exchange rates:", rates);

const formatCurrency = (amount: number, currency: string) => {
	try {
		return new Intl.NumberFormat(undefined, {
			style: "currency",
			currency,
		}).format(amount);
	} catch {
		// Fallback: symbol + localized number
		const symbol = currency === "EUR" ? "€" : "$";
		return `${symbol} ${amount.toLocaleString()}`;
	}
};

const convert = (amount: number, from: string, to: string) => {
	const rFrom = rates[from] ?? 1;
	const rTo = rates[to] ?? 1;
	return amount * (rTo / rFrom);
};

const displayValue =
	value > 0
		? formatCurrency(
				convert(value, baseCurrency, selectedCurrency),
				selectedCurrency,
			)
		: null;
---

<a
    href={href}
    class="group bg-white rounded-lg shadow-lg overflow-hidden transform transition-transform duration-300 hover:-translate-y-2 h-full flex flex-col"
>
    <!-- Contenedor de imagen con aspect ratio 3:2 -->
    <div class="relative w-full aspect-3/2 overflow-hidden">
        <ImageResource
            src={imageSrc}
            alt={imageAlt}
            width={600}
            height={400}
            classes="w-full h-full object-cover"
            wrapperClasses="w-full h-full"
        />
    </div>

    <div class="p-6 grow flex flex-col">
        {category && <p class="text-sm text-gray-500 mb-2">{category}</p>}
        <h3
            class="text-xl font-bold text-primary mb-2 group-hover:text-accent transition-colors"
        >
            {title}
        </h3>
        <p class="text-gray-600 text-sm mb-4 grow">{truncatedDescription}</p>

        {
            displayValue && (
                <div class="mb-4">
                    <span
                        class="text-lg font-bold text-accent dynamic-price"
                        data-base-value={value}
                        data-base-currency={baseCurrency}
                        data-rates={JSON.stringify(rates)}
                        data-label={valueLabel}
                    >
                        {valueLabel}: {displayValue}
                    </span>
                </div>
            )
        }

        {
            tags && tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mt-auto">
                    {tags.map((tag) => (
                        <span class="bg-gray-200 text-gray-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">
                            {tag}
                        </span>
                    ))}
                </div>
            )
        }
    </div>
</a>

<style>
    /* Asegurar que el contenedor de imagen no colapse */
    .aspect-\[3\/2\] {
        aspect-ratio: 3 / 2;
    }

    /* Fallback para navegadores antiguos sin soporte de aspect-ratio */
    @supports not (aspect-ratio: 3 / 2) {
        .aspect-\[3\/2\] {
            padding-bottom: 66.66%;
        }

        .aspect-\[3\/2\] > :global(.image-resource-wrapper) {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    }
</style>

<script>
    import { logger } from "@/services/logger.ts";
    const log = logger("InfoCard:Client");

    // Map of currency codes to symbols for manual fallback if needed
    const CURRENCY_SYMBOLS: Record<string, string> = {
        USD: "$",
        EUR: "€",
        GBP: "£",
        JPY: "¥",
        // Add others as needed
    };

    function getCurrencySymbol(currency: string): string {
        try {
            return (0)
                .toLocaleString(undefined, {
                    style: "currency",
                    currency,
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                })
                .replace(/\d/g, "")
                .trim();
        } catch {
            return CURRENCY_SYMBOLS[currency] || currency;
        }
    }

    function formatCurrency(amount: number, currency: string) {
        try {
            return new Intl.NumberFormat(undefined, {
                style: "currency",
                currency,
            }).format(amount);
        } catch {
            const symbol = CURRENCY_SYMBOLS[currency] || "$";
            return `${symbol}${amount.toLocaleString()}`;
        }
    }

    function updatePrice(element: HTMLElement, targetCurrency: string) {
        try {
            const baseValue = parseFloat(element.dataset.baseValue || "0");
            const baseCurrency = element.dataset.baseCurrency || "USD";
            const rates = JSON.parse(element.dataset.rates || "{}");
            const label = element.dataset.label || "Value";

            if (!rates[targetCurrency] || !rates[baseCurrency]) {
                log.warn(
                    `Missing rates for ${targetCurrency} or ${baseCurrency}`,
                );
                return;
            }

            const rFrom = rates[baseCurrency];
            const rTo = rates[targetCurrency];
            const convertedValue = baseValue * (rTo / rFrom);

            const formatted = formatCurrency(convertedValue, targetCurrency);

            // Update text content with label and formatted value (which includes symbol)
            element.textContent = `${label}: ${formatted}`;
        } catch (error) {
            log.error("Error updating price", error);
        }
    }

    function updateAllPrices(currency: string) {
        const prices = document.querySelectorAll(".dynamic-price");
        if (prices.length === 0) return;

        log.info(`Updating ${prices.length} items to ${currency}`);
        prices.forEach((el) => updatePrice(el as HTMLElement, currency));
    }

    function syncCurrencyFromStorage() {
        const stored = localStorage.getItem("currency");
        if (stored) {
            updateAllPrices(stored);
        }
    }

    // Listen for currency changes (custom event)
    document.addEventListener("currencyChanged", (e: any) => {
        const newCurrency = e.detail?.currency;
        if (newCurrency) {
            localStorage.setItem("currency", newCurrency); // Ensure it's saved
            updateAllPrices(newCurrency);
        }
    });

    // Initial check on load
    document.addEventListener("DOMContentLoaded", syncCurrencyFromStorage);

    // Support for View Transitions if/when enabled
    document.addEventListener("astro:page-load", syncCurrencyFromStorage);
</script>
