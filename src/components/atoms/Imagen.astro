---
// src/components/atoms/Imagen.astro
import { Image } from 'astro:assets';
import path from "node:path";
import fs from "node:fs";


interface Props {
    src: string | null | undefined;
    alt: string;
    width: number;
    height: number;
    class?: string;
    loading?: 'lazy' | 'eager';
    decoding?: 'async' | 'sync' | 'auto'; // Add decoding prop
}

const {
    src,
    alt,
    width,
    height,
    class: className,
    loading = 'lazy',
    decoding = 'async'
} = Astro.props;


// Prepare the placeholder URL for fallbacks
let finalSrc: string = `https://placehold.co/${width}x${height}/EAEAEA/29333B?text=${width}x${height}`;


function existeEnPublic(rutaPublica: string): boolean {
    // `rutaPublica` es algo como '/img/logo.png'
    const rutaCompleta = path.join(process.cwd(), 'public', rutaPublica);
    return fs.existsSync(rutaCompleta);
}

async function urlExist(url: string): Promise<boolean> {
    try {
        const res = await fetch(url, {method: 'HEAD'}); // solo cabecera, no descarga todo
        if (!res.ok) return false; // status != 2xx
        const contentType = res.headers.get('content-type') || '';
        return contentType.startsWith('image/'); // valida que sea imagen
    } catch (e) {
        return false;
    }
}

if (src && (src.startsWith('/') || src.startsWith('.'))) {
    // --- Handle Local Images ---
    // For optimization, local images must be in /src/assets/images/
    const images = import.meta.glob('/src/resources/img/**/*.{jpeg,jpg,png,gif,webp,svg}');
    const imagePath = `/src/resources${src.startsWith('/img') ? src : '/img' + src}`; // Normalize path

    if (images[imagePath]) {
        // If the image exists in our glob, we can use Astro's <Image> component.
        finalSrc = (await images[imagePath]()).default;
    } else if (existeEnPublic(src)) {
        finalSrc = src;
    }
} else if (src.startsWith('http')) {
    // Validamos que la URL exista y sea imagen
    const validate = await urlExist(src);
    if (validate) {
        finalSrc = src;
    }
}
---

<Image
        src={finalSrc}
        alt={alt}
        width={width}
        height={height}
        class:list={[className]}
        loading={loading}
        decoding={decoding}
/>
