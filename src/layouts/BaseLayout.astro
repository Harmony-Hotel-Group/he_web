---
// src/layouts/BaseLayout.astro

import Footer from "@/components/core/Footer.astro";
import Header from "@/components/core/Header.astro";
import WhatsAppButton from "@/components/atoms/WhatsAppButton.astro";
import ToastContainer from "@/components/organisms/notifications/ToastContainer.astro";
import SizeIndicator from "@/dev/SizeIndicator.astro";
import { getCurrentLang, Translations } from "@/i18n/translation";
import { logger } from "@/services/logger.ts";
import type { SiteConfig } from "@/types/config";
import "@/styles/global.css";

const log = logger("BaseLayout");

interface Props {
	titleKey: string;
	lang: string;
	config?: SiteConfig;
	description?: string;
	headerBgClass?: string;
}

let { titleKey, lang, config, description, headerBgClass } = Astro.props;
log.info("Props recibidas:", { titleKey, lang, config: !!config });

// Solo detectar idioma por URL pathname
const currentLang = getCurrentLang(Astro.url);
log.info("Idioma detectado:", currentLang);

const t = Translations(lang);
const metaDescription = description || t("meta.description");

// Construir URLs canónicas de forma segura
let cleanPath = "/";
// let baseUrl = "https://hotelensueños.com";
let baseUrl = import.meta.env.VERCEL_URL
	? `https://${import.meta.env.VERCEL_URL}`
	: "https://hotelensueños.com";

try {
	// Obtener el path de forma segura
	if (Astro.url?.pathname) {
		cleanPath = Astro.url.pathname.replace(/^\/en/, "") || "/";
	}

	// Obtener la URL base de forma segura
	if (Astro.site) {
		baseUrl = Astro.site.toString().replace(/\/$/, "");
	}
} catch (error) {
	log.warn("Error al construir URLs:", error);
}

// Construir URLs completas de forma segura
const esUrl = `${baseUrl}${cleanPath}`;
const enUrl = `${baseUrl}/en${cleanPath}`;
const canonicalUrl = currentLang === "es" ? esUrl : enUrl;

log.info("URLs generadas:", { esUrl, enUrl, canonicalUrl, cleanPath, baseUrl });
---

<html lang={currentLang}>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <meta name="description" content={metaDescription} />

        <!-- SEO: Enlaces alternativos -->
        <link rel="alternate" hreflang="es" href={esUrl} />
        <link rel="alternate" hreflang="en" href={enUrl} />
        <link rel="alternate" hreflang="x-default" href={esUrl} />

        <!-- Canonical -->
        <link rel="canonical" href={canonicalUrl} />

        <link rel="icon" type="image/svg+xml" href="/favicon.png" />
        <meta name="generator" content={Astro.generator} />

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap"
            rel="stylesheet"
        />

        <title>{t(titleKey)}</title>


        <!-- Required Core stylesheet -->
        <link rel="stylesheet" href="node_modules/@glidejs/glide/dist/css/glide.core.min.css">

        <!-- Optional Theme stylesheet -->
        <link rel="stylesheet" href="node_modules/@glidejs/glide/dist/css/glide.theme.min.css">
        <!--Capturar Metricas de pagina-->
        <script type="text/javascript">
            (function(e,c){if(!c.__SV){var l,h;window.mixpanel=c;c._i=[];c.init=function(q,r,f){function t(d,a){var g=a.split(".");2==g.length&&(d=d[g[0]],a=g[1]);d[a]=function(){d.push([a].concat(Array.prototype.slice.call(arguments,0)))}}var b=c;"undefined"!==typeof f?b=c[f]=[]:f="mixpanel";b.people=b.people||[];b.toString=function(d){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);d||(a+=" (stub)");return a};b.people.toString=function(){return b.toString(1)+".people (stub)"};l="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders start_session_recording stop_session_recording people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");
                for(h=0;h<l.length;h++)t(b,l[h]);var n="set set_once union unset remove delete".split(" ");b.get_group=function(){function d(p){a[p]=function(){b.push([g,[p].concat(Array.prototype.slice.call(arguments,0))])}}for(var a={},g=["get_group"].concat(Array.prototype.slice.call(arguments,0)),m=0;m<n.length;m++)d(n[m]);return a};c._i.push([q,r,f])};c.__SV=1.2;var k=e.createElement("script");k.type="text/javascript";k.async=!0;k.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===
            e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";e=e.getElementsByTagName("script")[0];e.parentNode.insertBefore(k,e)}})(document,window.mixpanel||[])

            mixpanel.init('e040001aeb9bd7a07479c1d22231068d', {
                autocapture: true,
                record_sessions_percent: 100,
            })

        </script>
    </head>
    <body class="min-w-[850px] flex flex-col min-h-screen overflow-x-hidden">
        <Header
            config={config as SiteConfig}
            lang={lang}
            headerBgClass={headerBgClass}
        />
        <main class="grow w-full overflow-x-hidden">
            <slot />
        </main>
        <WhatsAppButton />
        <Footer t={t} config={config as SiteConfig} lang={lang} />
        <ToastContainer />
        <SizeIndicator />
    </body>
</html>
