---
// src/components/core/LangSelector.astro
import {
	getCurrentLang,
	languages,
	supportedLangs,
} from "@/i18n/translation.ts";
import { logger } from "@/services/logger.ts";

const log = logger("LangSelector");

interface Props {
	currentLang?: string;
}
const { currentLang } = Astro.props as Props;

// 游 SERVER SIDE (Astro SSR)
log.info("游릭 [SSR] Ejecutando LangSelector en el servidor");

const currentLangCode =
	(currentLang as string) || getCurrentLang(Astro.url, Astro.request);
log.info("游릭 [SSR] Lang para selector (prop/url):", currentLangCode);

const uiLanguages = languages.filter((l) =>
	supportedLangs.includes(l.code as any),
);
log.info(
	"游릭 [SSR] Idiomas visibles en selector:",
	uiLanguages.map((l) => l.code),
);

const selectedLang =
	uiLanguages.find((lang) => lang.code === currentLangCode) || uiLanguages[0];

log.info("游릭 [SSR] Idioma seleccionado:", selectedLang);
---

<div class="relative mr-2" id="lang-switcher-container">
    <button
            type="button"
            id="lang-switcher-button"
            class="flex items-center bg-transparent text-white py-1 px-2 rounded-md cursor-pointer focus:outline-none text-sm"
            aria-haspopup="true"
            aria-expanded="false"
    >
        <img
                src={selectedLang.flag}
                alt={`Bandera de ${selectedLang.name}`}
                class="h-5 w-5"
                id="lang-switcher-flag"
        />
    </button>

    <div
            id="lang-switcher-dropdown"
            class="absolute right-0 mt-2 w-36 bg-gray-700 rounded-md shadow-lg z-20 hidden"
    >
        {uiLanguages.map((lang) => (
                <button
                        type="button"
                        class="lang-option flex items-center space-x-2 w-full text-left px-3 py-2 text-sm text-white hover:bg-gray-600"
                        data-lang-code={lang.code}
                >
                    <img src={lang.flag} alt={`Bandera de ${lang.name}`} class="h-4 w-4" />
                    <span>{lang.name}</span>
                </button>
        ))}
    </div>
</div>

<script>
    import { logger } from "@/services/logger.ts";
    const log = logger("LangSelector");

    document.addEventListener('DOMContentLoaded', () => {
        log.info("游릭 [CLIENT] LangSelector montado (DOM listo)");

        const container = document.getElementById('lang-switcher-container');
        const button = document.getElementById('lang-switcher-button');
        const dropdown = document.getElementById('lang-switcher-dropdown');

        if (!container || !button || !dropdown) {
            log.error("游댮 [CLIENT] Elementos del LangSelector no encontrados");
            return;
        }

        log.info("游릭 [CLIENT] Elementos encontrados correctamente");

        // Sincronizar bandera al cargar seg칰n la cookie
        const mainFlagEl = document.getElementById('lang-switcher-flag') as HTMLImageElement | null;
        try {
            const cookieLang = document.cookie.split('; ').find(r => r.startsWith('lang='))?.split('=')[1] || 'es';
            const desiredBtn = document.querySelector(`#lang-switcher-dropdown .lang-option[data-lang-code="${cookieLang}"]`) as HTMLButtonElement | null;
            const optionImg = desiredBtn?.querySelector('img') as HTMLImageElement | null;
            if (mainFlagEl && optionImg) {
                mainFlagEl.src = optionImg.src;
                mainFlagEl.alt = optionImg.alt;
                log.info('游릭 [CLIENT] Bandera sincronizada al cargar:', cookieLang);
            }
        } catch (e) {
            log.warn('丘멆잺 [CLIENT] No se pudo sincronizar bandera al cargar', e);
        }

        // --- Toggle del dropdown ---
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = dropdown.classList.toggle('hidden');
            button.setAttribute('aria-expanded', String(!isHidden));
            log.info("游 Toggle dropdown:", !isHidden ? "abierto" : "cerrado");
        });

        // --- Cerrar si se hace click fuera ---
        document.addEventListener('click', () => {
            if (!dropdown.classList.contains('hidden')) {
                dropdown.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
                log.info("游 Dropdown cerrado por click externo");
            }
        });

        // --- Manejo de cambio de idioma ---
        const langButtons: NodeListOf<HTMLButtonElement> = dropdown.querySelectorAll('.lang-option');
        langButtons.forEach(langButton => {
            langButton.addEventListener('click', () => {
                const newLangCode = langButton.dataset.langCode;
                const currentPath = window.location.pathname;
                const query = window.location.search || '';
                const hash = window.location.hash || '';

                log.info("游 Idioma seleccionado:", newLangCode);
                log.info("游 Path actual:", currentPath);

                if (!newLangCode) {
                    log.warn('丘멆잺 C칩digo de idioma inv치lido:', newLangCode);
                    return;
                }

                // Actualizar inmediatamente la bandera del bot칩n (feedback instant치neo)
                const optionImg = langButton.querySelector('img') as HTMLImageElement | null;
                if (mainFlagEl && optionImg) {
                    mainFlagEl.src = optionImg.src;
                    mainFlagEl.alt = optionImg.alt;
                }

                // Actualizar cookie
                document.cookie = `lang=${newLangCode}; path=/; max-age=31536000; SameSite=Lax`;

                // Determinar la ruta real (con /en/ si es necesario)
                let targetPath = currentPath;

                if (newLangCode === 'en') {
                    // Si cambiamos a ingl칠s, agregar /en/ al path
                    if (!currentPath.startsWith('/en')) {
                        targetPath = '/en' + currentPath;
                    }
                } else {
                    // Si cambiamos a espa침ol, quitar /en/ del path
                    targetPath = currentPath.replace(/^\/en/, '') || '/';
                }

                const fullUrl = targetPath + query + hash;
                log.info('游릭 Redirigiendo a:', fullUrl);
                window.location.href = fullUrl;
            });
        });
    });
</script>

