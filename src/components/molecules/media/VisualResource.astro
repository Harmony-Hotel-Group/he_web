---
// src/components/media/VisualResource.astro
/**
 * Componente principal que delega a subcomponentes específicos
 * Solo carga el componente necesario para mejor performance
 */

import type { ImageMetadata } from "astro";
import ImageResource from "./ImageResource.astro";
import VideoResource from "./VideoResource.astro";
import { logger } from "@/services/logger.ts";
import {detectResourceType,	type ResourceType,	validateResource,	extractYouTubeId,} from "@/utils/visual-resource-utils.ts";
import YouTubeResource from "./YouTubeResource.astro";

const log = logger("VisualResource");

interface Props {
	src: string | ImageMetadata;
	type?: "image" | "video" | "youtube" | "auto";
	alt?: string;
	classes?: string;
	loading?: "lazy" | "eager";
	width?: number;
	height?: number;
	autoplay?: boolean;
	loop?: boolean;
	muted?: boolean;
	controls?: boolean;
	placeholder?: string;
	poster?: string;
	srcset?: string;
	sizes?: string;
}

const {
	src,
	type = "auto",
	alt = "",
	classes = "",
	loading = "lazy",
	width = 600,
	height = 400,
	autoplay = false,
	loop = false,
	muted = true,
	controls = true,
	placeholder,
	poster,
	srcset,
	sizes,
} = Astro.props;

const PlaceHolder =
	placeholder ||
	`https://placehold.co/${width}x${height}?text=Recurso+No+Encontrado`;

// Detectar tipo de recurso
const detectedType: ResourceType =
	type === "auto" ? detectResourceType(src) : (type as ResourceType);

log.info(
	`Recurso: ${typeof src === "string" ? src : "ImageMetadata"} | Tipo recibido: ${type} | Tipo detectado: ${detectedType}`,
);

// Validar recurso (solo en build time, no en runtime)
const validation = await validateResource(src, detectedType);

log.info(
	`[VisualResource] Validación del recurso:`,
	{
		isValid: validation.isValid,
		error: validation.error,
		finalSrc: typeof validation.finalSrc === "string" ? validation.finalSrc : "ImageMetadata",
		detectedType,
		type,
	},
);

if (!validation.isValid) {
	log.warn(
		`Recurso no válido o no encontrado: '${typeof src === "string" ? src : "ImageMetadata"}'. Usando placeholder. Razón: ${validation.error}`,
	);
}
---

{
	!src || !validation.isValid ? (
		<ImageResource src={PlaceHolder} alt={alt || "Recurso no encontrado"} />
	) : detectedType === "youtube" ? (
		(() => {
			const videoId = extractYouTubeId(src as string) || "";
			log.info(`[VisualResource] Renderizando YouTubeResource con videoId: ${videoId}, autoplay: ${autoplay}, loop: ${loop}, muted: ${muted}, controls: ${controls}`);
			return (
				<YouTubeResource
					videoid={videoId}
					classes={classes}
					title={alt}
					autoplay={autoplay}
					loop={loop}
					muted={muted}
					controls={controls}
				/>
			);
		})()
	) : detectedType === "video" ? (
		<VideoResource
			src={(validation.finalSrc as string) || (src as string)}
			classes={classes}
			width={width}
			height={height}
			autoplay={autoplay}
			loop={loop}
			muted={muted}
			controls={controls}
			poster={poster}
			placeholder={placeholder}
		/>
	) : (
		<ImageResource
			src={validation.finalSrc ?? src}
			alt={alt}
			width={width}
			height={height}
			loading={loading}
			classes={classes}
			srcset={srcset}
			sizes={sizes}
		/>
	)
}
