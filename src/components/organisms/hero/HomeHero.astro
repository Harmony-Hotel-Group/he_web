---
// src/components/organisms/hero/HomeHero.astro
import VisualResource from "@/components/molecules/media/VisualResource.astro";
import VisualCarousel from "@/components/organisms/carousel/VisualCarousel.astro";
import { logger } from "@/services/logger.ts";
import {
	detectResourceType,
	validateResource,
} from "@/utils/visual-resource-utils.ts";
import type { Resource } from "@/types/resource";
import ImageResource from "@/components/molecules/media/ImageResource.astro";

const log = logger("HomeHero");

interface Props {
	resources: Resource[];
	prioritizeVideo?: boolean;
}

const { resources = [], prioritizeVideo = true } = Astro.props;

log.info("Props recibidas:", {
	numResources: resources.length,
	prioritizeVideo,
});

const defaultPlaceholderResources: Resource[] = [
	{
		src: "https://placehold.co/1920x1080/1a1a1a/ffffff?text=Slide+1",
		type: "image",
		alt: "Placeholder 1",
	},
];

const userAgent = Astro.request.headers.get("user-agent") || "";
const isMobileDevice = /Mobile|Android|iPhone|iPad|iPod|Windows Phone/i.test(
	userAgent,
);

let validatedResources: Resource[] = [];
if (resources && resources.length > 0) {
	for (const res of resources) {
		// Siempre detectar el tipo primero para asegurar que YouTube se detecte correctamente
		// incluso si el tipo está mal configurado como "video"
		const detectedType = detectResourceType(res.src);
		const type =
			!res.type || res.type === "auto"
				? detectedType
				: detectedType === "youtube" && res.type === "video"
					? "youtube" // Corregir tipo mal configurado: si detectamos YouTube pero está marcado como "video", usar "youtube"
					: res.type;

		log.info(
			`Recurso: ${typeof res.src === "string" ? res.src : "ImageMetadata"} | Tipo original: ${res.type} | Tipo detectado: ${detectedType} | Tipo final: ${type}`,
		);

		const validation = await validateResource(res.src, type);
		log.warn("Validando recurso:", type, validation);

		// Para YouTube, la validación puede ser válida incluso sin finalSrc
		// porque YouTube siempre devuelve la URL original como finalSrc
		if (validation.isValid) {
			const finalSrc = validation.finalSrc || res.src;
			log.info(
				`Recurso válido agregado: tipo=${type}, src=${typeof finalSrc === "string" ? finalSrc : "ImageMetadata"}`,
			);
			validatedResources.push({
				...res,
				type,
				src: finalSrc,
			});
		} else {
			log.warn(
				`Recurso inválido filtrado: tipo=${type}, error=${validation.error}`,
			);
		}
	}
}

log.info("Recursos validados:", validatedResources);

if (validatedResources.length === 0) {
	validatedResources = defaultPlaceholderResources;
}

const videos = validatedResources.filter((r) => r.type === "video");
const youtubeVideos = validatedResources.filter((r) => r.type === "youtube");
const images = validatedResources.filter((r) => r.type === "image");

let finalResources: Resource[];
let displayMode: "video" | "carousel" = "carousel";

if (prioritizeVideo && !isMobileDevice) {
	if (youtubeVideos.length > 0) {
		finalResources = [youtubeVideos[0]];
		displayMode = "video";
	} else if (videos.length > 0) {
		finalResources = [videos[0]];
		displayMode = "video";
	} else {
		finalResources = images.length > 0 ? images : defaultPlaceholderResources;
	}
} else {
	finalResources = images.length > 0 ? images : defaultPlaceholderResources;
}

log.info(
	`Modo de visualización: ${displayMode}. Recursos finales:`,
	finalResources.map((r) => r.src),
);
---

{
	displayMode === "video" ? (
		<>
			<div class="relative w-full h-screen overflow-hidden z-0">
				<VisualResource
					src={finalResources[0].src}
					type={finalResources[0].type}
					alt={finalResources[0].alt}
					autoplay={true}
					loop={true}
					muted={true}
					controls={false}
					classes="absolute inset-0 w-full h-full"
				/>
				<div class="absolute inset-0 z-10 pointer-events-none bg-black/50" />
			</div>
		</>
	) : (
		<VisualCarousel resources={finalResources} />
	)
}
