---
// src/components/atoms/SearchInput.astro
interface Option {
	value: string;
	label: string;
}

interface Props {
	label?: string;
	name: string;
	id?: string;
	placeholder?: string;
	options: Option[];
	className?: string;
	labelClass?: string;
	inputClass?: string;
	dropdownClass?: string;
}

const {
	label,
	name,
	id = name,
	placeholder = "",
	options = [],
	className,
	labelClass,
	inputClass,
	dropdownClass,
} = Astro.props;

const uniqueId = `search-input-${Math.random().toString(36).slice(2)}`;
const inputId = `${uniqueId}-input`;
const dropdownId = `${uniqueId}-dropdown`;
---

<div class:list={['flex flex-col relative', className]}>
  {label && (
    <label for={inputId} class:list={['block text-sm font-medium text-primary mb-1', labelClass]}>
      {label}
    </label>
  )}
  <input
    type="text"
    id={inputId}
    name={name}
    placeholder={placeholder}
    autocomplete="off"
    class:list={[
      'block w-full px-3 py-2 border border-gray-300 rounded-md shadow-xs ',
      'text-primary placeholder-gray-400 focus:outline-hidden focus:ring-accent focus:border-accent sm:text-sm',
      inputClass
    ]}
  />
  <div 
    id={dropdownId} 
    class:list={[
      'absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg z-40 hidden',
      dropdownClass
    ]}
  >
    {/* Suggestions will be rendered here by JavaScript */}
  </div>
</div>

<script define:vars={{ uniqueId, inputId, dropdownId, options }}>
  function setupSearchInput() {
    const inputElement = document.getElementById(inputId);
    const dropdownElement = document.getElementById(dropdownId);

    if (!inputElement || !dropdownElement) return;

    let filteredOptions = [];

    const renderDropdown = () => {
      dropdownElement.innerHTML = '';
      if (filteredOptions.length === 0 || inputElement.value.trim() === '') {
        dropdownElement.classList.add('hidden');
        return;
      }

      dropdownElement.classList.remove('hidden');
      filteredOptions.forEach(option => {
        const item = document.createElement('div');
        item.classList.add('px-3', 'py-2', 'text-sm', 'text-primary', 'cursor-pointer', 'hover:bg-accent/20');
        item.textContent = option.label;
        item.addEventListener('click', () => {
          inputElement.value = option.label;
          dropdownElement.classList.add('hidden');
          // You might want to dispatch a custom event here to notify parent components
          // inputElement.dispatchEvent(new CustomEvent('select', { detail: option.value }));
        });
        dropdownElement.appendChild(item);
      });
    };

    inputElement.addEventListener('input', () => {
      const query = inputElement.value.toLowerCase();
      filteredOptions = options.filter(option => 
        option.label.toLowerCase().includes(query)
      );
      renderDropdown();
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (event) => {
      if (!inputElement.contains(event.target) && !dropdownElement.contains(event.target)) {
        dropdownElement.classList.add('hidden');
      }
    });

    // Show dropdown on focus if there's content
    inputElement.addEventListener('focus', () => {
      if (inputElement.value.trim() !== '') {
        const query = inputElement.value.toLowerCase();
        filteredOptions = options.filter(option => 
          option.label.toLowerCase().includes(query)
        );
        renderDropdown();
      } else {
        filteredOptions = options; // Show all options on focus if input is empty
        renderDropdown();
      }
    });
  }

  document.addEventListener('astro:page-load', setupSearchInput);
</script>
