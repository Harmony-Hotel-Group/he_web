---
import {
	getCurrentLang,
	languages,
	SUPPORTED_LANGS,
	type SupportedLang,
} from "@/i18n/translation.ts";
import { logger } from "@/services/logger.ts";

const log = logger("LangSelector");

const currentLangCode = getCurrentLang(Astro.url);
log.info("游릭 [SSR] Lang para selector:", currentLangCode);

const uiLanguages = languages.filter((l) =>
	SUPPORTED_LANGS.includes(l.code as SupportedLang),
);

const selectedLang =
	uiLanguages.find((lang) => lang.code === currentLangCode) || uiLanguages[0];

function getUrlForLang(langCode: string) {
	const currentPath = Astro.url.pathname;
	const currentPathWithoutLang = currentPath.replace(/^\/(en|fr)/, "");

	if (langCode === "es") {
		return currentPathWithoutLang;
	}
	return `/${langCode}${currentPathWithoutLang}`;
}
---

<div class="relative mr-2" id="lang-switcher-container">
	<button
		type="button"
		id="lang-switcher-button"
		class="flex items-center bg-transparent text-white py-1 px-2 rounded-md cursor-pointer focus:outline-none text-sm"
		aria-haspopup="true"
		aria-expanded="false"
	>
		<img
			src={selectedLang.flag}
			alt={`Bandera de ${selectedLang.name}`}
			class="h-5 w-5"
			id="lang-switcher-flag"
		/>
	</button>

	<div
		id="lang-switcher-dropdown"
		class="absolute right-0 mt-2 w-36 bg-gray-700 rounded-md shadow-lg z-20 hidden"
	>
		{uiLanguages.map((lang) => (
			<a
				href={getUrlForLang(lang.code)}
				class="flex items-center space-x-2 w-full text-left px-3 py-2 text-sm text-white hover:bg-gray-600"
			>
				<img
					src={lang.flag}
					alt={`Bandera de ${lang.name}`}
					class="h-4 w-4"
				/>
				<span>{lang.name}</span>
			</a>
		))}
	</div>
</div>

<script>
	document.addEventListener("DOMContentLoaded", async () => {
        // Importaci칩n din치mica para el cliente
        const { logger } = await import('@/services/logger.ts');
        const log = logger("LangSelector:Client");

        log.info("游릭 [CLIENT] LangSelector montado");

		const container = document.getElementById("lang-switcher-container");
		const button = document.getElementById("lang-switcher-button");
		const dropdown = document.getElementById("lang-switcher-dropdown");

		if (!container || !button || !dropdown) {
            log.error("游댮 [CLIENT] Elementos del LangSelector no encontrados");
            return;
        }

		button.addEventListener("click", (e) => {
			e.stopPropagation();
			dropdown.classList.toggle("hidden");
			button.setAttribute("aria-expanded", String(!dropdown.classList.contains("hidden")));
		});

		document.addEventListener("click", () => {
			if (!dropdown.classList.contains("hidden")) {
				dropdown.classList.add("hidden");
				button.setAttribute("aria-expanded", "false");
			}
		});
	});
</script>
