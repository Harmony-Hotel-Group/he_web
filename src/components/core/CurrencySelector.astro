---
// src/components/core/CurrencySwitcher.astro
import { logger } from "@/services/logger.ts";

const log = logger("CurrencySwitcher");

import eurFlag from "@/assets/img/currents/eur.svg";
import gbpFlag from "@/assets/img/currents/gbp.svg";
// Importar las im√°genes de forma est√°tica
import usdFlag from "@/assets/img/currents/usd.svg";

// Definir monedas disponibles
const currencies = [
	{ code: "USD", symbol: "$", image: usdFlag.src },
	{ code: "EUR", symbol: "‚Ç¨", image: eurFlag.src },
	{ code: "GBP", symbol: "¬£", image: gbpFlag.src },
];

const defaultCurrency = currencies[0]; // USD por defecto

log.info(
	"üü¢ [SSR] CurrencySwitcher cargado con monedas:",
	currencies.map((c) => c.code),
);
---

<div class="relative" id="currency-switcher-container">
    <!-- Bot√≥n principal -->
    <button
            type="button"
            id="currency-switcher-button"
            class="flex items-center bg-transparent text-white py-1 px-2 rounded-md cursor-pointer focus:outline-none text-sm"
            aria-haspopup="true"
            aria-expanded="false"
    >
        <img
                src={defaultCurrency.image}
                alt={`${defaultCurrency.code} symbol`}
                class="h-5 w-5"
                id="currency-switcher-flag"
        />
        <span class="hidden ml-1" id="currency-switcher-code">
            {defaultCurrency.code}
        </span>
        <svg
                class="w-3 h-3 ml-1 hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
        >
            <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
            ></path>
        </svg>
    </button>

    <!-- Dropdown -->
    <div
            id="currency-switcher-dropdown"
            class="absolute right-0 mt-2 w-24 bg-gray-700 rounded-md shadow-lg z-20 hidden"
    >
        {currencies.map((currency) => (
                <button
                        type="button"
                        class="currency-option flex items-center space-x-1 w-full text-left px-3 py-2 text-sm text-white hover:bg-gray-600"
                        data-currency-code={currency.code}
                        data-currency-symbol={currency.symbol}
                        data-currency-image={currency.image}
                >
                    <img
                            src={currency.image}
                            alt={`${currency.code} symbol`}
                            class="h-4 w-4"
                    />
                    <span>{currency.code}</span>
                </button>
        ))}
    </div>
</div>

<script>

    // Definici√≥n de tipos
    type Currency = {
        code: string;
        symbol: string;
        image: string;
    };

    // Esta funci√≥n se ejecutar√° cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', async () => {
        // Importaci√≥n din√°mica: La clave para que funcione con un solo archivo.
        const { logger } = await import('@/services/logger.ts');
        const log = logger("CurrencySwitcher:Client");

        log.info("üü¢ [CLIENT] CurrencySwitcher montado");

    // Funci√≥n para obtener moneda desde localStorage
    function getStoredCurrency(): string {
        if (typeof localStorage === 'undefined') return 'USD';
        return localStorage.getItem('currency') || 'USD';
    }

    function storeCurrency(currencyCode: string): void {
        if (typeof localStorage === 'undefined') return;
        localStorage.setItem('currency', currencyCode);
        log.info('üü¢ [CLIENT] Moneda guardada en localStorage:', currencyCode);
    }

    // Funci√≥n para obtener datos de moneda desde el DOM
    function getCurrencyData(code: string): Currency | null {
        const button = document.querySelector(
            `.currency-option[data-currency-code="${code}"]`
        ) as HTMLButtonElement | null;

        if (!button) return null;

        return {
            code: button.dataset.currencyCode || 'USD',
            symbol: button.dataset.currencySymbol || '$',
            image: button.dataset.currencyImage || '',
        };
    }

    // Funci√≥n para actualizar la UI con la moneda seleccionada
    function updateCurrencyUI(currency: Currency): void {
        const flagEl = document.getElementById('currency-switcher-flag') as HTMLImageElement | null;
        const codeEl = document.getElementById('currency-switcher-code') as HTMLSpanElement | null;

        if (flagEl && currency.image) {
            flagEl.src = currency.image;
            flagEl.alt = `${currency.code} symbol`;
        }

        if (codeEl) {
            codeEl.textContent = currency.code;
        }

        log.info('üü¢ [CLIENT] UI actualizada con moneda:', currency.code);
    }

    // Funci√≥n para actualizar todos los precios en la p√°gina
    function updatePrices(newCurrencyCode: string): void {
        // Dispatch custom event para que otros componentes escuchen
        const event = new CustomEvent('currencyChanged', {
            detail: { currency: newCurrencyCode },
            bubbles: true,
            composed: true
        });
        document.dispatchEvent(event);

        log.info('üü¢ [CLIENT] Evento currencyChanged disparado:', newCurrencyCode);
    }

        const container = document.getElementById('currency-switcher-container');
        const button = document.getElementById('currency-switcher-button');
        const dropdown = document.getElementById('currency-switcher-dropdown');

        if (!container || !button || !dropdown) {
            log.error("üî¥ [CLIENT] Elementos del CurrencySwitcher no encontrados");
            return;
        }

        // Cargar moneda guardada y actualizar UI
        const storedCurrencyCode = getStoredCurrency();
        const storedCurrency = getCurrencyData(storedCurrencyCode);

        if (storedCurrency) {
            updateCurrencyUI(storedCurrency);
            // Disparar evento inicial para que los precios se actualicen
            updatePrices(storedCurrency.code);
        }

        // Toggle del dropdown
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = dropdown.classList.toggle('hidden');
            button.setAttribute('aria-expanded', String(!isHidden));
            log.info("üü† Toggle dropdown:", !isHidden ? "abierto" : "cerrado");
        });

        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', (e) => {
            const target = e.target as HTMLElement;
            if (!container.contains(target)) {
                if (!dropdown.classList.contains('hidden')) {
                    dropdown.classList.add('hidden');
                    button.setAttribute('aria-expanded', 'false');
                    log.info("üü† Dropdown cerrado por click externo");
                }
            }
        });

        // Manejar cambio de moneda
        const currencyButtons = dropdown.querySelectorAll('.currency-option') as NodeListOf<HTMLButtonElement>;

        currencyButtons.forEach(currencyButton => {
            currencyButton.addEventListener('click', () => {
                const newCurrencyCode = currencyButton.dataset.currencyCode;

                if (!newCurrencyCode) {
                    log.warn('‚ö†Ô∏è C√≥digo de moneda inv√°lido');
                    return;
                }

                log.info("üü† Moneda seleccionada:", newCurrencyCode);

                const newCurrency = getCurrencyData(newCurrencyCode);

                if (!newCurrency) {
                    log.error('üî¥ No se pudieron obtener datos de la moneda');
                    return;
                }

                // Actualizar UI inmediatamente
                updateCurrencyUI(newCurrency);

                // Guardar en localStorage
                storeCurrency(newCurrencyCode);

                // Cerrar dropdown
                dropdown.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');

                // Actualizar precios
                updatePrices(newCurrencyCode);

                // Opcional: Recargar la p√°gina si necesitas refrescar todo
                // Descomenta la siguiente l√≠nea si prefieres recargar
                window.location.reload();
            });
        });
    });
</script>