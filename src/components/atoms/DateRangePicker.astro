---
import { Translations } from "~/i18n/translation.ts";

interface Props {
    forId: string;
    lang?: string;
    name?: string;
}

const {lang, forId, name} = Astro.props;
const t = Translations(lang);
console.log("DateRangePicker.astro Completely loaded");
---

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />

<style>
    .date-range-picker-input {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<div class="relative w-full">
    <input
            id={forId}
            name={name}
            type="text"
            data-lang={lang}
            data-for-id={forId}
            placeholder=`${t('components.placeholders.dateRangePicker')}`
            readonly
            class="w-full p-2 border rounded-md cursor-pointer date-range-picker-input"
    />
    <span id=`error_${forId}` class="hidden text-red-700">{t("components.errors.dateRangePicker")} *</span>
</div>

<script>
    import flatpickr from "flatpickr";
    import "flatpickr/dist/l10n/es.js";
    import { defaultLang, Translations } from "~/i18n/translation.ts";

    function runDatePicker(input) {
        const lang = input.dataset.lang || defaultLang;
        const t = Translations(lang);

        flatpickr(input, {
            mode: "range",
            minDate: "today",
            dateFormat: "Y/m/d",
            // locale: lang === "es" ? flatpickr.l10ns.es : flatpickr.l10ns.default,
            locale: flatpickr.l10ns[lang] ?? flatpickr.l10ns.default,

            onChange: function (selectedDates, dateStr, instance) {
                if (selectedDates.length === 0) {
                    input.value = "";
                    input.removeAttribute("title");
                    return;
                }

                const formatDate = (d) => {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, "0");
                    const day = String(d.getDate()).padStart(2, "0");
                    return `${y}/${m}/${day}`;
                };

                if (selectedDates.length === 1) {
                    input.value = formatDate(selectedDates[0]);
                    input.title = input.value;
                }
                if (selectedDates.length === 2) {
                    const [start, end] = selectedDates;

                    if (start.toDateString() === end.toDateString()) {
                        instance.clear();
                        const message =
                            lang === "es"
                                ? "Debes seleccionar al menos 2 días diferentes."
                                : "You must select at least 2 different days.";
                        alert(message);
                        return;
                    }

                    const nights = Math.round((end - start) / (1000 * 60 * 60 * 24));

                    const nightsLabel =
                        lang === "es"
                            ? `${nights} ${nights === 1 ? "noche" : "noches"}`
                            : `${nights} ${nights === 1 ? "night" : "nights"}`;

                    const text = `${formatDate(start)} ➜ ${formatDate(end)} (${nightsLabel})`;

                    input.value = text;
                    input.title = text;
                }
            },
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        const inputs = document.querySelectorAll('input[data-for-id]');
        inputs.forEach(input => {
            console.log("input", input);
            runDatePicker(input);
        });
    });
</script>
