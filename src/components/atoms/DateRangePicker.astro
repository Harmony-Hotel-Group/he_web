---
interface Props {
    forId: string;
    t: (key: string) => string;
    lang?: string; // 'en' o 'es'
}

const { t , lang = 'es', forId} = Astro.props;
---

<link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>

<style>
    #date-range-picker {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<div class="relative w-full">
    <input
            id={forId}
            type="text"
            data-lang={lang}
    placeholder={t('booking.dateRangePlaceholder') || "Select a date range"}
    readonly
    class="w-full p-2 border rounded-md cursor-pointer"
    />
</div>

<script>
    import flatpickr from "flatpickr";
    import "flatpickr/dist/l10n/es.js";

    function runDatePicker(input) {
        console.log("Running date picker",input);
        const lang = input.dataset.lang || "es";
        console.log("lang",lang);
        flatpickr(input, {
            mode: "range",
            minDate: "today",
            dateFormat: "Y/m/d",
            locale: lang === "es" ? flatpickr.l10ns.es : flatpickr.l10ns.default,

            onChange: function (selectedDates, dateStr, instance) {
                console.log("onChange");
                if (selectedDates.length === 0) {
                    input.value = "";
                    input.removeAttribute("title");
                    return;
                }

                const formatDate = (d) => {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, "0");
                    const day = String(d.getDate()).padStart(2, "0");
                    return `${y}/${m}/${day}`;
                };

                if (selectedDates.length === 1) {
                    input.value = formatDate(selectedDates[0]);
                    input.title = input.value;
                }

                if (selectedDates.length === 2) {
                    const [start, end] = selectedDates;

                    if (start.toDateString() === end.toDateString()) {
                        instance.clear();
                        const message =
                            lang === "es"
                                ? "Debes seleccionar al menos 2 dÃ­as diferentes."
                                : "You must select at least 2 different days.";
                        alert(message);
                        return;
                    }

                    const nights = Math.round((end - start) / (1000 * 60 * 60 * 24));

                    const nightsLabel =
                        lang === "es"
                            ? `${nights} ${nights === 1 ? "noche" : "noches"}`
                            : `${nights} ${nights === 1 ? "night" : "nights"}`;

                    const text = `${formatDate(start)} -> ${formatDate(end)} (${nightsLabel})`;

                    input.value = text;
                    input.title = text;
                }
            },
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        const input = document.getElementById("date-range-picker");
        if (input) runDatePicker(input);
    });
</script>
